<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ø³ØªØ¶Ø§ÙØ© Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ± - Kids Area</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø¯ÙŠØ«Ø© --- */
        :root {
            --primary: #ff4757;
            --primary-hover: #ff6b81;
            --secondary: #2f3542;
            --accent: #1e90ff;
            --success: #2ed573;
            --warning: #ffa502;
            --danger: #ff4757;
            --bg-body: #f1f2f6;
            --surface: #ffffff;
            --whatsapp: #25D366;
            --radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© --- */
        * { 
            box-sizing: border-box; margin: 0; padding: 0; 
            font-family: 'Tajawal', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            outline: none;
        }
        
        body { 
            background-color: var(--bg-body); 
            color: var(--secondary); 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            font-size: 16px;
            overflow-x: hidden;
        }

        /* --- Receipt Modal Styling (ØªØµÙ…ÙŠÙ… Ø§Ù„ÙØ§ØªÙˆØ±Ø©) --- */
        .receipt-card {
            background: #fff;
            width: 100%;
            border-radius: 0;
            position: relative;
            overflow: hidden;
        }
        .receipt-header {
            background: var(--secondary);
            color: white;
            padding: 20px;
            text-align: center;
            border-bottom: 5px solid var(--primary);
        }
        .receipt-body {
            padding: 20px;
            background: #fff;
        }
        .receipt-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.95rem;
            color: #555;
        }
        .receipt-row.bold {
            font-weight: bold;
            color: #000;
            font-size: 1.1rem;
        }
        .dashed-divider {
            border-bottom: 2px dashed #ccc;
            margin: 15px 0;
            position: relative;
        }
        /* Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„ÙˆØ±Ù‚ */
        .dashed-divider::before, .dashed-divider::after {
            content: '';
            position: absolute;
            top: -10px;
            width: 20px;
            height: 20px;
            background: rgba(0,0,0,0.7); /* Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø© Ù„Ù„Ù…ÙˆØ¯Ø§Ù„ */
            border-radius: 50%;
        }
        .dashed-divider::before { left: -30px; }
        .dashed-divider::after { right: -30px; }
        
        .receipt-total-box {
            background: #f1f2f6;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            margin-top: 15px;
        }
        .receipt-footer {
            text-align: center;
            font-size: 0.8rem;
            color: #888;
            margin-top: 20px;
            font-style: italic;
        }

        /* --- Product Management Styles --- */
        .mini-product-list {
            margin-bottom: 15px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 5px;
            background: #fafafa;
        }
        .mini-product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 6px;
            border-bottom: 1px solid #f1f1f1;
        }
        .btn-delete-mini {
            background: #ff7675;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex; align-items: center; justify-content: center;
        }

        /* --- Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª ÙƒÙ…Ø§ Ù‡ÙŠ --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        header { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 0; 
            position: sticky; top: 0; z-index: 1000; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .header-top { background: var(--secondary); color: white; padding: 8px 20px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;}
        .header-content { padding: 15px 20px; display: flex; align-items: center; gap: 20px; max-width: 1200px; margin: 0 auto;}
        .logo-img { height: 55px; width: 55px; background: white; border-radius: 50%; padding: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid var(--bg-body);}
        .header-text h1 { color: var(--primary); font-weight: 800; font-size: 1.5rem; margin-bottom: 0.2rem; }
        .header-text p { color: #7f8c8d; font-size: 0.9rem; }
        
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #ff9ff3 0%, #feca57 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-card { background: rgba(255, 255, 255, 0.95); padding: 3rem 2rem; border-radius: 24px; width: 90%; max-width: 420px; text-align: center; }
        .login-input { width: 100%; padding: 18px; background: #f7f9fc; border-radius: 12px; font-size: 1.3rem; text-align: center; margin: 2rem 0; letter-spacing: 8px; font-weight: bold; border: 2px solid transparent;}
        
        main { flex: 1; padding: 2rem 1rem; max-width: 1200px; margin: 0 auto; width: 100%; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 992px) { .dashboard-grid { grid-template-columns: 380px 1fr; } }
        
        .card { background: var(--surface); border-radius: var(--radius); padding: 1.8rem; box-shadow: 0 8px 24px rgba(149, 157, 165, 0.1); margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1.2rem; }
        .form-control { width: 100%; padding: 14px; background: #f8f9fa; border: 1px solid #dfe4ea; border-radius: 12px; font-size: 1rem; }
        
        .btn { padding: 14px 24px; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 1rem; display: inline-flex; align-items: center; justify-content: center; gap: 10px; width: 100%; transition: all 0.3s;}
        @media (min-width: 768px) { .btn { width: auto; min-width: 120px; } }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-whatsapp { background: var(--whatsapp); color: white; }
        .btn-info { background: var(--accent); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--secondary); color: var(--secondary); }
        
        .search-box { background: white; padding: 0.8rem 1.2rem; border-radius: 50px; margin-bottom: 1.5rem; display: flex; gap: 15px; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05);}
        .search-box input { border: none; flex: 1; outline: none; font-size: 1rem; }
        
        .kid-card { background: white; border-radius: 16px; padding: 1.2rem; margin-bottom: 1rem; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); position: relative; overflow: hidden; border: 1px solid #f1f2f6;}
        .kid-card::before { content: ''; position: absolute; top: 0; right: 0; width: 6px; height: 100%; }
        .kid-card.in-status::before { background: var(--success); }
        .kid-card.paused-status::before { background: var(--warning); }
        .kid-card.out-status::before { background: #ccc; }
        
        @media (min-width: 600px) { .kid-card { flex-direction: row; justify-content: space-between; align-items: center; } }
        .kid-info h3 { font-size: 1.15rem; font-weight: 700; color: var(--secondary); display: flex; align-items: center; gap: 8px; }
        .kid-tag { background: #f1f2f6; color: #747d8c; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; }
        .timer-display { font-family: 'Courier New', monospace; font-weight: 800; color: var(--primary); font-size: 1.1rem; background: rgba(255, 71, 87, 0.05); padding: 5px 10px; border-radius: 8px; display: inline-block;}
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 2rem; border-radius: 24px; width: 90%; max-width: 450px; }
        
        .hidden { display: none !important; }
        
        /* Parent View Styles (Simplified) */
        .parent-view-card { text-align: center; border-radius: 30px; padding: 2.5rem 1.5rem; background: rgba(255, 255, 255, 0.95); margin-top: 2rem; position: relative; z-index: 10; box-shadow: 0 20px 50px rgba(0,0,0,0.08); }
        .parent-timer-circle { width: 200px; height: 200px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin: 30px auto; border: 8px solid rgba(255, 71, 87, 0.1); }
        .timer-text-big { font-size: 3rem; font-weight: 900; color: var(--secondary); }
        .scene-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%); pointer-events: none; }
        
        /* Chat */
        .chat-container { margin-top: 1.5rem; background: #e5ddd5; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; }
        .chat-messages { height: 300px; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .message { padding: 8px 12px; border-radius: 8px; max-width: 80%; font-size: 0.9rem; position: relative; }
        .message.received { align-self: flex-start; background: white; color: #111; border-top-left-radius: 0; }
        .message.sent { align-self: flex-end; background: #dcf8c6; color: #111; border-top-right-radius: 0; }
        .chat-input-area { padding: 10px; background: #f0f0f0; display: flex; gap: 10px; }
        .chat-input-area input { flex:1; padding: 10px; border-radius: 20px; border:none; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <img src="https://raw.githubusercontent.com/mohamednasr5/opera/main/01.png" alt="Logo" style="width:100px; margin-bottom:15px; border-radius: 50%; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
            <h2>Ø§Ø³ØªØ¶Ø§ÙØ© Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ±</h2>
            <p style="color:#666; margin-bottom:20px;">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p>
            <input type="password" id="login-pass" class="login-input" placeholder="****" onkeypress="handleEnter(event)">
            <button class="btn btn-primary" onclick="checkLogin()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <header>
        <div class="header-top">
            <span>ğŸ“… <span id="header-datetime">...</span></span>
            <div id="admin-controls" style="display:flex; gap:10px;">
                <button id="nav-logout-btn" class="hidden" style="background:none; border:none; color:white; cursor:pointer;" onclick="logout()">Ø®Ø±ÙˆØ¬ <i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
        <div class="header-content">
            <img src="https://raw.githubusercontent.com/mohamednasr5/opera/main/01.png" alt="Logo" class="logo-img">
            <div class="header-text">
                <h1>ğŸª Ø§Ø³ØªØ¶Ø§ÙØ© Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ±</h1>
                <p id="header-subtitle">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØªØ¨Ø¹ Ø§Ù„Ø£Ø·ÙØ§Ù„</p>
            </div>
        </div>
    </header>

    <main id="app">
        
        <div id="admin-view" class="hidden">
            <div class="dashboard-grid">
                
                <section class="card">
                    <h2 style="margin-bottom: 1.5rem; color: var(--primary);">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø·ÙÙ„ Ø¬Ø¯ÙŠØ¯</h2>
                    <form id="checkin-form">
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„</label>
                            <input type="text" id="child-name" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„" required>
                        </div>
                        <div class="form-group">
                            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="tel" id="parent-phone" class="form-control" placeholder="01xxxxxxxxx" required>
                        </div>
                        <div class="form-group">
                            <label>Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <input type="text" id="extra-item" class="form-control" placeholder="Ù…Ø«Ù„Ø§Ù‹: ÙØ´Ø§Ø±">
                        </div>
                        <div class="form-group">
                            <label>Ø§Ù„Ø³Ø¹Ø±</label>
                            <input type="number" id="extra-price" class="form-control" placeholder="Ø¬.Ù…">
                        </div>
                        <button type="submit" class="btn btn-primary">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
                    </form>
                    
                    <div id="new-child-qr" class="hidden text-center" style="margin-top: 1.5rem; border-top: 1px dashed #ccc; padding-top: 1rem;">
                        <h3 style="color: var(--success);">âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
                        <div id="qr-code" style="display:flex; justify-content:center; margin: 15px 0;"></div>
                        <div style="display:grid; gap:10px;">
                            <button class="btn btn-whatsapp" id="wa-btn-new">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨</button>
                            <button class="btn btn-outline" onclick="closeQR()">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                </section>

                <section>
                    <div class="search-box">
                        <i class="fas fa-search" style="color:#aaa;"></i>
                        <input type="text" id="admin-search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯...">
                    </div>
                    <div class="card">
                        <h2 style="margin-bottom:1rem;">ğŸ‘¶ Ø§Ù„Ø£Ø·ÙØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†</h2>
                        <div id="kids-list-active"></div>
                    </div>
                    <div class="card" style="background: #fafafa;">
                        <h2 style="margin-bottom:1rem; color:#7f8c8d;">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…</h2>
                        <div id="kids-list-history"></div>
                    </div>
                </section>
            </div>
        </div>

        <div id="parent-view" class="hidden">
            <div class="scene-container"></div>
            <div class="parent-view-card">
                <div id="p-status-badge" style="padding:5px 15px; border-radius:20px; display:inline-block; font-weight:bold; margin-bottom:10px;"></div>
                <h2 id="p-child-name"></h2>
                <div id="p-child-id" style="color:#666; margin-bottom:10px;"></div>
                <div class="parent-timer-circle">
                    <div class="timer-text-big" id="live-timer">00:00:00</div>
                </div>
                <h3 style="color:var(--primary); margin:20px 0;">Ø§Ù„ØªÙƒÙ„ÙØ©: <span id="live-cost">0</span> Ø¬.Ù…</h3>
                
                <div class="chat-container">
                    <div id="parent-chat-messages" class="chat-messages"></div>
                    <div class="chat-input-area">
                        <input type="text" id="parent-message-input" placeholder="Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©...">
                        <button class="btn btn-primary" onclick="sendParentMessage()" style="width:auto; border-radius:50%; padding:10px 15px;">â¤</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="admin-chat-modal" class="modal">
        <div class="modal-content" style="height:80vh; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3 id="chat-modal-title">Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
                <button onclick="closeAdminChat()" style="background:none; border:none; font-size:1.5rem;">&times;</button>
            </div>
            <div id="admin-chat-history" class="chat-messages" style="flex:1;"></div>
            <div class="chat-input-area">
                <input type="text" id="admin-chat-input" placeholder="Ø±Ø¯...">
                <button class="btn btn-primary" onclick="sendAdminMessage()" style="width:auto;">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <div id="checkout-modal" class="modal">
        <div class="modal-content" style="padding: 0; background: transparent; max-width: 380px;">
            <div class="receipt-card">
                <div class="receipt-header">
                    <img src="https://raw.githubusercontent.com/mohamednasr5/opera/main/01.png" style="width:50px; border-radius:50%; border:2px solid white; margin-bottom:5px;">
                    <h3>Ø§Ø³ØªØ¶Ø§ÙØ© Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ±</h3>
                </div>
                <div class="receipt-body">
                    <div class="receipt-row bold">
                        <span>Ø§Ù„Ø·ÙÙ„:</span>
                        <span id="receipt-child-name">--</span>
                    </div>
                    <div class="receipt-row">
                        <span>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨:</span>
                        <span id="receipt-hours-text" dir="ltr">--</span>
                    </div>
                    
                    <div class="dashed-divider"></div>
                    
                    <div style="font-weight:bold; margin-bottom:10px;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª:</div>
                    <div id="receipt-products-list"></div>

                    <div class="dashed-divider"></div>

                    <div class="receipt-total-box">
                        <div style="font-size:0.9rem; color:#777;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</div>
                        <div class="receipt-total" id="receipt-grand-total">0 Ø¬.Ù…</div>
                    </div>

                    <div style="display:grid; gap:10px; margin-top:20px;">
                        <a id="receipt-whatsapp-btn" href="#" target="_blank" class="btn btn-whatsapp">
                            <i class="fab fa-whatsapp"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ§ØªØ³Ø§Ø¨
                        </a>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-danger" onclick="confirmCheckout()">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                            <button class="btn btn-outline" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                    
                    <div class="receipt-footer">
                        Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ… .. Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… ÙŠÙˆÙ…Ø§Ù‹ Ø³Ø¹ÙŠØ¯Ø§Ù‹!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="add-product-modal" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--accent); margin-bottom: 1rem; text-align:center;">ğŸ›ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
            
            <div id="current-products-list" class="mini-product-list">
                </div>

            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                <input type="text" id="new-product-name" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø¹ØµÙŠØ±">
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ø³Ø¹Ø±</label>
                <input type="number" id="new-product-price" class="form-control" placeholder="0">
            </div>
            
            <div style="display:flex; gap:10px; justify-content:center; margin-top: 15px;">
                <button class="btn btn-info" onclick="submitAddProduct()">Ø¥Ø¶Ø§ÙØ© ÙˆØ¥ØºÙ„Ø§Ù‚</button>
                <button class="btn btn-outline" onclick="closeProductModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <audio id="msg-sound" src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_3f32527b79.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, set, get, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDIH-wzZV71U-zbkxArRE4f9oiCtwvKOWA",
            authDomain: "operaestdafa.firebaseapp.com",
            databaseURL: "https://operaestdafa-default-rtdb.firebaseio.com",
            projectId: "operaestdafa",
            storageBucket: "operaestdafa.firebasestorage.app",
            messagingSenderId: "44885598287",
            appId: "1:44885598287:web:e2b0d3497b86c69de38a3a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- GLOBAL VARIABLES ---
        let currentChildId = null; 
        let currentChildLink = "";
        let childIdForProduct = null;
        let searchQuery = "";
        let currentChatId = null;

        // --- DOM ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const adminView = document.getElementById('admin-view');
        const parentView = document.getElementById('parent-view');
        
        // --- AUTH & ROUTING ---
        window.handleEnter = (e) => { if(e.key === 'Enter') checkLogin(); }
        window.checkLogin = () => {
            const p = document.getElementById('login-pass').value;
            if(p === '0100') {
                loginScreen.classList.add('hidden');
                adminView.classList.remove('hidden');
                document.getElementById('nav-logout-btn').classList.remove('hidden');
                initAdminView();
            } else { alert("Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"); }
        };
        window.logout = () => location.reload();

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('mode') === 'parent' && urlParams.get('id')) {
            loginScreen.classList.add('hidden');
            initParentView(urlParams.get('id'));
        }

        // --- DATE ---
        setInterval(() => {
            document.getElementById('header-datetime').innerText = new Date().toLocaleDateString('ar-EG', { weekday:'long', hour:'2-digit', minute:'2-digit' });
        }, 1000);

        // =============================================
        // ADMIN LOGIC
        // =============================================
        function initAdminView() {
            onValue(ref(db, 'children'), (snapshot) => {
                const data = snapshot.val();
                const listActive = document.getElementById('kids-list-active');
                const listHistory = document.getElementById('kids-list-history');
                listActive.innerHTML = ''; listHistory.innerHTML = '';
                
                if(!data) return;

                Object.keys(data).forEach(key => {
                    const child = data[key];
                    const link = `${window.location.origin}${window.location.pathname}?mode=parent&id=${key}`;
                    
                    // ØªØ­Ø¶ÙŠØ± Ù†Øµ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                    let productHTML = '';
                    let productsTotal = 0;
                    if(child.products) {
                        productHTML = '<div style="font-size:0.8rem; color:#666; margin-top:5px;">ğŸ›’ ';
                        Object.values(child.products).forEach(p => {
                            productHTML += `${p.name}, `;
                            productsTotal += parseFloat(p.price);
                        });
                        productHTML += `(Ù…Ø¬Ù…ÙˆØ¹: ${productsTotal} Ø¬.Ù…)</div>`;
                    }

                    if (child.status === 'in' || child.status === 'paused') {
                        const isPaused = child.status === 'paused';
                        let duration = isPaused 
                            ? (child.pauseStartTime - child.entryTime - (child.totalPausedTime||0))
                            : (Date.now() - child.entryTime - (child.totalPausedTime||0));
                        
                        // 2. Ù…Ù†Ø·Ù‚ Ø§Ù„ÙˆÙ‚Øª: Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø¬Ø¨ÙˆØ±Ø© Ù„Ù„Ø¹Ø±Ø¶
                        const hoursCeil = Math.ceil(duration / 3600000); // 1 Ø¯Ù‚ÙŠÙ‚Ø© = 1 Ø³Ø§Ø¹Ø©
                        const displayTime = isPaused ? formatDuration(duration) : formatDuration(duration); // Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±

                        const div = document.createElement('div');
                        div.className = `kid-card ${isPaused ? 'paused-status' : 'in-status'}`;
                        div.setAttribute('data-search', `${child.name} ${child.phone} ${child.childId}`);
                        
                        // Ø²Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ù…Ø¹ Ø¹Ø¯Ø¯ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡)
                        const msgs = child.messages ? Object.values(child.messages) : [];
                        const unread = msgs.filter(m => m.sender === 'parent' && m.status !== 'read').length;
                        const badge = unread > 0 ? `<span style="background:red; color:white; border-radius:50%; padding:2px 6px; font-size:0.7rem; position:absolute; top:-5px; right:-5px;">${unread}</span>` : '';

                        div.innerHTML = `
                            <div class="kid-info">
                                <h3>${child.name} <span style="background:#eee; padding:2px 8px; border-radius:5px; font-size:0.8rem;">#${child.childId}</span></h3>
                                <div style="font-size:0.85rem; color:#888;">ğŸ“± ${child.phone}</div>
                                ${productHTML}
                                <div class="timer-display" style="${isPaused?'color:orange;':''}">
                                    â³ ${isPaused ? 'Ù…Ø¤Ù‚Øª' : 'Ø¬Ø§Ø±ÙŠ'}: <span class="live-timer" data-start="${child.entryTime}" data-paused="${child.totalPausedTime||0}" data-status="${child.status}">${formatDuration(duration)}</span>
                                    <span style="font-size:0.8rem; color:#333; margin-right:5px;">(${hoursCeil} Ø³)</span>
                                </div>
                            </div>
                            <div style="display:flex; gap:5px; flex-wrap:wrap; justify-content:flex-end;">
                                <button class="btn btn-info" style="width:auto; padding:8px;" onclick="openProductModal('${key}')" title="Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª"><i class="fas fa-shopping-basket"></i></button>
                                <button class="btn btn-primary" style="width:auto; padding:8px; position:relative;" onclick="openAdminChat('${key}', '${child.name}')"><i class="fas fa-comments"></i> ${badge}</button>
                                ${isPaused 
                                    ? `<button class="btn btn-success" style="width:auto; padding:8px;" onclick="resumeChild('${key}')"><i class="fas fa-play"></i></button>`
                                    : `<button class="btn btn-warning" style="width:auto; padding:8px;" onclick="pauseChild('${key}')"><i class="fas fa-pause"></i></button>`
                                }
                                <button class="btn btn-danger" style="width:auto; padding:8px;" onclick="prepareCheckout('${key}')">Ø®Ø±ÙˆØ¬</button>
                            </div>
                        `;
                        listActive.appendChild(div);
                    } else {
                        // Ø§Ù„ØªØ§Ø±ÙŠØ®
                        const div = document.createElement('div');
                        div.className = 'kid-card out-status';
                        div.setAttribute('data-search', `${child.name} ${child.phone} ${child.childId}`);
                        div.innerHTML = `
                            <div class="kid-info">
                                <h3 style="color:#777; text-decoration:line-through;">${child.name}</h3>
                                <div>ğŸ’° ${child.totalCost} Ø¬.Ù… | ğŸ“… ${new Date(child.exitTime).toLocaleTimeString('ar-EG')}</div>
                            </div>
                        `;
                        listHistory.appendChild(div);
                    }
                });
                filterList();
            });

            // Timer Loop
            setInterval(() => {
                document.querySelectorAll('.live-timer').forEach(el => {
                    if(el.dataset.status === 'in') {
                        const t = Date.now() - parseInt(el.dataset.start) - parseInt(el.dataset.paused);
                        el.innerText = formatDuration(t);
                    }
                });
            }, 1000);
        }

        // --- ADD NEW CHILD ---
        document.getElementById('checkin-form').onsubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById('child-name').value;
            const phone = document.getElementById('parent-phone').value;
            const item = document.getElementById('extra-item').value;
            const price = document.getElementById('extra-price').value;

            const newRef = push(ref(db, 'children'));
            const code = Math.floor(1000 + Math.random() * 9000);
            
            const data = {
                name, phone, childId: code,
                entryTime: Date.now(), status: 'in', totalPausedTime: 0
            };
            set(newRef, data).then(() => {
                if(item && price) {
                    push(ref(db, `children/${newRef.key}/products`), { name: item, price: parseFloat(price) });
                }
                document.getElementById('checkin-form').reset();
                const link = `${window.location.origin}${window.location.pathname}?mode=parent&id=${newRef.key}`;
                
                // Show QR
                const qrDiv = document.getElementById('new-child-qr');
                qrDiv.classList.remove('hidden');
                document.getElementById('qr-code').innerHTML = '';
                new QRCode(document.getElementById('qr-code'), { text: link, width:100, height:100 });
                document.getElementById('wa-btn-new').onclick = () => window.open(`https://wa.me/${phone}?text=${encodeURIComponent('Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©: ' + link)}`, '_blank');
            });
        };
        window.closeQR = () => document.getElementById('new-child-qr').classList.add('hidden');

        // --- SEARCH ---
        document.getElementById('admin-search').addEventListener('input', (e) => {
            searchQuery = e.target.value.toLowerCase();
            filterList();
        });
        function filterList() {
            document.querySelectorAll('.kid-card').forEach(card => {
                const txt = card.getAttribute('data-search').toLowerCase();
                card.style.display = txt.includes(searchQuery) ? 'flex' : 'none';
            });
        }

        // --- ACTIONS (Pause/Resume) ---
        window.pauseChild = (id) => update(ref(db, `children/${id}`), { status:'paused', pauseStartTime: Date.now() });
        window.resumeChild = (id) => {
            get(ref(db, `children/${id}`)).then(s => {
                const d = s.val();
                const p = Date.now() - d.pauseStartTime;
                update(ref(db, `children/${id}`), { status:'in', totalPausedTime: (d.totalPausedTime||0) + p });
            });
        };

        // =============================================
        // 4. PRODUCT MODAL LOGIC (ØªØ·ÙˆÙŠØ± Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª)
        // =============================================
        window.openProductModal = (id) => {
            childIdForProduct = id;
            const listContainer = document.getElementById('current-products-list');
            listContainer.innerHTML = '<div style="text-align:center; color:#999;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            get(ref(db, `children/${id}/products`)).then(snap => {
                listContainer.innerHTML = '';
                if(snap.exists()) {
                    snap.forEach(pSnap => {
                        const p = pSnap.val();
                        const item = document.createElement('div');
                        item.className = 'mini-product-item';
                        item.innerHTML = `
                            <span>${p.name} (${p.price} Ø¬.Ù…)</span>
                            <button class="btn-delete-mini" onclick="deleteProduct('${id}', '${pSnap.key}')"><i class="fas fa-trash"></i></button>
                        `;
                        listContainer.appendChild(item);
                    });
                } else {
                    listContainer.innerHTML = '<div style="text-align:center; padding:10px; color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø³Ø¬Ù„Ø©</div>';
                }
            });

            document.getElementById('new-product-name').value = '';
            document.getElementById('new-product-price').value = '';
            document.getElementById('add-product-modal').style.display = 'flex';
        };

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        window.deleteProduct = (childId, prodKey) => {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) {
                remove(ref(db, `children/${childId}/products/${prodKey}`)).then(() => {
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                    openProductModal(childId);
                });
            }
        };

        window.closeProductModal = () => document.getElementById('add-product-modal').style.display = 'none';

        window.submitAddProduct = () => {
            const name = document.getElementById('new-product-name').value;
            const price = document.getElementById('new-product-price').value;
            if(!name || !price) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

            push(ref(db, `children/${childIdForProduct}/products`), {
                name: name, price: parseFloat(price)
            }).then(() => {
                // Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„ØªÙˆÙÙŠØ± Ø§Ù„ÙˆÙ‚Øª
                closeProductModal();
            });
        };

        // =============================================
        // 1. & 2. CHECKOUT LOGIC & RECEIPT (Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ§Ù„ÙˆÙ‚Øª)
        // =============================================
        window.prepareCheckout = (id) => {
            currentChildId = id;
            get(ref(db, `children/${id}`)).then(s => {
                const c = s.val();
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø©
                let ms = c.status === 'paused' 
                    ? c.pauseStartTime - c.entryTime - (c.totalPausedTime||0)
                    : Date.now() - c.entryTime - (c.totalPausedTime||0);
                
                // 2. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ù…Ø¬Ø¨ÙˆØ±Ø© (Time Calculation Logic)
                // Ø¯Ø§Ù„Ø© Ø§Ù„Ø³Ù‚Ù (Ceiling): 1 Ø¯Ù‚ÙŠÙ‚Ø© = 1 Ø³Ø§Ø¹Ø©
                const hours = Math.ceil(ms / 3600000); 
                const safeHours = hours === 0 ? 1 : hours; // Ø£Ù‚Ù„ Ø­Ø§Ø¬Ø© Ø³Ø§Ø¹Ø©
                const timeCost = safeHours * 20; // 20 Ø¬Ù†ÙŠÙ‡ Ù„Ù„Ø³Ø§Ø¹Ø©

                // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                let productsCost = 0;
                let productsListHTML = '';
                let productsTextForWA = '';

                if(c.products) {
                    Object.values(c.products).forEach(p => {
                        productsCost += parseFloat(p.price);
                        productsListHTML += `
                            <div class="receipt-row">
                                <span>${p.name}</span>
                                <span>${p.price} Ø¬.Ù…</span>
                            </div>
                        `;
                        productsTextForWA += `\nğŸ›ï¸ ${p.name}: ${p.price} Ø¬.Ù…`;
                    });
                } else {
                    productsListHTML = '<div style="color:#999; text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>';
                    productsTextForWA = '\nğŸ›ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©';
                }

                const grandTotal = timeCost + productsCost;

                // 1. ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Checkout Modal)
                document.getElementById('receipt-child-name').innerText = c.name;
                document.getElementById('receipt-hours-text').innerText = `${safeHours} Ø³Ø§Ø¹Ø© (${timeCost} Ø¬.Ù…)`;
                document.getElementById('receipt-products-list').innerHTML = productsListHTML;
                document.getElementById('receipt-grand-total').innerText = `${grandTotal} Ø¬.Ù…`;

                // 3. ØªÙ†Ø³ÙŠÙ‚ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ (WhatsApp Format)
                const waText = `ğŸ§¾ *ÙØ§ØªÙˆØ±Ø© Ø§Ø³ØªØ¶Ø§ÙØ© Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ±*
------------------------
ğŸ‘¤ *Ø§Ù„Ø·ÙÙ„:* ${c.name}
â³ *Ø§Ù„ÙˆÙ‚Øª:* ${safeHours} Ø³Ø§Ø¹Ø§Øª
ğŸ’° *Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª:* ${timeCost} Ø¬.Ù…
${productsTextForWA}
------------------------
ğŸ’µ *Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:* *${grandTotal} Ø¬.Ù…*
ğŸ“… ${new Date().toLocaleDateString('ar-EG')}
------------------------
Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ…! â¤ï¸`;

                const waLink = `https://wa.me/${c.phone}?text=${encodeURIComponent(waText)}`;
                document.getElementById('receipt-whatsapp-btn').href = waLink;

                // Ø­ÙØ¸ Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯
                document.getElementById('checkout-modal').dataset.total = grandTotal;
                
                document.getElementById('checkout-modal').style.display = 'flex';
            });
        };

        window.confirmCheckout = () => {
            const total = document.getElementById('checkout-modal').dataset.total;
            update(ref(db, `children/${currentChildId}`), {
                status: 'out',
                exitTime: Date.now(),
                totalCost: total
            }).then(() => {
                closeModal();
            });
        };
        window.closeModal = () => document.getElementById('checkout-modal').style.display = 'none';

        // --- CHAT SYSTEM ---
        window.openAdminChat = (id, name) => {
            currentChatId = id;
            document.getElementById('chat-modal-title').innerText = name;
            document.getElementById('admin-chat-modal').style.display = 'flex';
            
            // Mark as read
            get(ref(db, `children/${id}/messages`)).then(s => {
                if(s.exists()) {
                    s.forEach(child => {
                        if(child.val().sender === 'parent' && child.val().status !== 'read') {
                            update(ref(db, `children/${id}/messages/${child.key}`), {status: 'read'});
                        }
                    });
                }
            });

            onValue(ref(db, `children/${id}/messages`), s => {
                const div = document.getElementById('admin-chat-history');
                div.innerHTML = '';
                if(s.exists()) {
                    Object.values(s.val()).forEach(m => {
                        const d = document.createElement('div');
                        d.className = `message ${m.sender === 'admin' ? 'sent' : 'received'}`;
                        d.innerText = m.text;
                        div.appendChild(d);
                    });
                    div.scrollTop = div.scrollHeight;
                }
            });
        };
        window.closeAdminChat = () => document.getElementById('admin-chat-modal').style.display = 'none';
        window.sendAdminMessage = () => {
            const txt = document.getElementById('admin-chat-input').value;
            if(!txt) return;
            push(ref(db, `children/${currentChatId}/messages`), {
                sender: 'admin', text: txt, timestamp: Date.now(), status: 'new'
            });
            document.getElementById('admin-chat-input').value = '';
        };

        // --- HELPERS ---
        function formatDuration(ms) {
            const s = Math.floor((ms/1000)%60).toString().padStart(2,'0');
            const m = Math.floor((ms/60000)%60).toString().padStart(2,'0');
            const h = Math.floor(ms/3600000).toString().padStart(2,'0');
            return `${h}:${m}:${s}`;
        }
    </script>
</body>
</html>
