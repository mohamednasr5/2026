<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ± | Kids Area</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Ø¥Ø¶Ø§ÙØ© Three.js Ù„Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† 3D -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        /* --- Modern Design System (2024 Theme) --- */
        :root {
            --primary-gradient: linear-gradient(135deg, #6C5CE7 0%, #a29bfe 100%);
            --danger-gradient: linear-gradient(135deg, #FF7675 0%, #fab1a0 100%);
            --success-gradient: linear-gradient(135deg, #00b894 0%, #55efc4 100%);
            --warning-gradient: linear-gradient(135deg, #fdcb6e 0%, #ffeaa7 100%);
            
            --primary-color: #6C5CE7;
            --dark-text: #2d3436;
            --light-text: #636e72;
            --bg-color: #dfe6e9;
            
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: 1px solid rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --backdrop: blur(16px);
            
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            
            --font-main: 'Almarai', 'Tajawal', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; padding: 0;
            font-family: var(--font-main);
            background: #f0f2f5;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            color: var(--dark-text);
            min-height: 100vh;
            display: flex; flex-direction: column;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }

        /* --- Animations --- */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- Login Screen --- */
        #login-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: linear-gradient(45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            display: flex; justify-content: center; align-items: center;
            padding: 20px;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .login-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            padding: 3rem 2rem;
            border-radius: 30px;
            width: 100%; max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .login-input {
            width: 100%; padding: 15px;
            border: 2px solid #eee; border-radius: var(--radius-md);
            background: #f9f9f9; font-size: 1.5rem; text-align: center; letter-spacing: 5px; font-weight: bold;
            margin: 20px 0; transition: 0.3s;
        }
        .login-input:focus { border-color: var(--primary-color); background: #fff; box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.2); }

        /* --- Header --- */
        header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            position: sticky; top: 0; z-index: 1000;
            border-bottom: 1px solid rgba(255,255,255,0.5);
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            margin-bottom: 20px;
        }
        .header-top {
            background: var(--dark-text); color: #fff; font-size: 0.8rem; padding: 6px 15px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-content {
            padding: 10px 20px; max-width: 1200px; margin: 0 auto;
            display: flex; align-items: center; gap: 15px;
        }
        .logo-img {
            width: 50px; height: 50px; border-radius: 50%; background: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid #fff;
        }
        .header-text h1 { margin: 0; font-size: 1.3rem; color: var(--primary-color); font-weight: 800; }
        .header-text p { margin: 0; font-size: 0.85rem; color: var(--light-text); font-weight: 500; }

        /* --- Layout --- */
        main { max-width: 1200px; margin: 0 auto; padding: 0 15px 80px; width: 100%; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 992px) { .dashboard-grid { grid-template-columns: 350px 1fr; } }

        /* --- Cards --- */
        .card {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop);
            border: var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--glass-shadow);
            margin-bottom: 20px;
            animation: slideUp 0.4s ease-out;
        }

        /* --- Forms --- */
        .form-control {
            width: 100%; padding: 14px;
            border: 1px solid transparent; background: #fff;
            border-radius: var(--radius-sm); font-size: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            transition: 0.3s;
            font-family: var(--font-main);
        }
        .form-control:focus {
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
            border-color: var(--primary-color);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 700; color: var(--light-text); font-size: 0.9rem; }

        /* --- Buttons --- */
        .btn {
            border: none; padding: 12px 20px; border-radius: var(--radius-sm);
            font-weight: 700; font-family: var(--font-main); cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.3s; width: 100%; font-size: 1rem;
            position: relative; overflow: hidden;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4); }
        .btn-danger { background: var(--danger-gradient); color: white; box-shadow: 0 4px 15px rgba(255, 118, 117, 0.4); }
        .btn-success { background: var(--success-gradient); color: white; box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4); }
        .btn-warning { background: var(--warning-gradient); color: #2d3436; }
        .btn-whatsapp { background: #25D366; color: white; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3); }
        .btn-outline { background: transparent; border: 2px solid var(--dark-text); color: var(--dark-text); }
        
        @media (min-width: 600px) { .btn { width: auto; } }

        /* --- Kid Card Style --- */
        .kid-card {
            background: #fff; border-radius: var(--radius-md);
            padding: 15px; margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.02);
            position: relative; overflow: hidden;
            display: flex; flex-direction: column; gap: 15px;
            transition: 0.3s;
        }
        .kid-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        @media (min-width: 600px) { .kid-card { flex-direction: row; justify-content: space-between; align-items: center; } }

        /* Status Indicators as Borders */
        .kid-card::before { content: ''; position: absolute; top: 0; right: 0; bottom: 0; width: 5px; }
        .kid-card.in-status::before { background: #00b894; }
        .kid-card.paused-status::before { background: #fdcb6e; }
        .kid-card.out-status::before { background: #b2bec3; }

        .kid-info h3 { margin: 0 0 5px; font-size: 1.1rem; color: var(--dark-text); display: flex; align-items: center; gap: 8px;}
        .kid-id-badge { background: #f0f2f5; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; color: #636e72; }
        .kid-meta { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .kid-tag { background: #f1f2f6; color: #636e72; font-size: 0.8rem; padding: 4px 10px; border-radius: 20px; font-weight: 600; }
        
        .timer-display { font-family: 'Segoe UI', monospace; font-weight: 800; background: rgba(108, 92, 231, 0.1); color: var(--primary-color); padding: 5px 12px; border-radius: 8px; display: inline-block; font-size: 1.1rem;}
        .timer-paused { background: rgba(253, 203, 110, 0.1); color: #e17055; }

        .controls { display: flex; gap: 8px; flex-wrap: wrap; width: 100%; justify-content: flex-end; }
        @media (min-width: 600px) { .controls { width: auto; } }
        .controls .btn { padding: 8px 12px; font-size: 0.85rem; border-radius: 10px; min-width: auto; }

        /* --- Search --- */
        .search-box {
            background: #fff; border-radius: 50px; padding: 10px 20px;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 20px;
            border: 2px solid transparent; transition: 0.3s;
        }
        .search-box:focus-within { border-color: var(--primary-color); box-shadow: 0 5px 20px rgba(108, 92, 231, 0.15); }
        .search-box input { border: none; flex: 1; font-size: 1rem; font-family: var(--font-main); }
        .search-box i { color: #b2bec3; }

        /* --- Chat --- */
        .chat-container { border: 1px solid #eee; border-radius: var(--radius-md); background: #fff; overflow: hidden; margin-top: 15px; }
        .chat-messages { height: 250px; overflow-y: auto; padding: 15px; background: #f8f9fa; display: flex; flex-direction: column; gap: 10px; }
        .message { padding: 10px 15px; border-radius: 15px; font-size: 0.9rem; max-width: 80%; line-height: 1.4; position: relative; }
        .message.parent { align-self: flex-start; background: #fff; border-bottom-right-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .message.admin { align-self: flex-end; background: var(--dark-text); color: white; border-bottom-left-radius: 2px; }
        .chat-input-area { padding: 10px; background: #fff; border-top: 1px solid #eee; display: flex; gap: 10px; }

        /* --- Parent View Enhancements --- */
        .parent-view-card {
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 40px;
            padding: 40px 20px;
            box-shadow: 0 20px 80px rgba(0,0,0,0.15);
            text-align: center;
            max-width: 500px; margin: 20px auto;
            position: relative; z-index: 10;
        }
        .parent-timer-circle {
            width: 200px; height: 200px; background: #fff; border-radius: 50%;
            margin: 0 auto 20px; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 8px solid #f0f2f5;
            position: relative;
        }
        .timer-text-big { font-size: 3rem; font-weight: 800; color: var(--primary-color); letter-spacing: -2px; }
        .child-number-display { background: var(--dark-text); color: white; padding: 5px 20px; border-radius: 20px; font-weight: bold; position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); white-space: nowrap; }

        /* --- Footer --- */
        .developer-footer {
            background: rgba(255,255,255,0.95) !important;
            backdrop-filter: blur(10px);
            padding: 15px; text-align: center;
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
            border-top: 1px solid rgba(0,0,0,0.05);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .developer-footer a { color: var(--primary-color); text-decoration: none; font-weight: bold; font-size: 0.9rem; }
        
        /* --- Helper Classes --- */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .section-title { font-size: 1.1rem; color: var(--light-text); margin-bottom: 15px; font-weight: 800; border-right: 4px solid var(--primary-color); padding-right: 10px; }

        /* --- Modals --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; justify-content: center; align-items: center; padding: 20px;}
        .modal-content { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: var(--radius-lg); animation: popIn 0.3s; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .modal-chat-content { height: 80vh; display: flex; flex-direction: column; }

        /* --- 3D Animation Container --- */
        #three-scene-container {
            position: fixed; inset: 0; z-index: 0; pointer-events: all; /* Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø§ÙˆØ³ */
            opacity: 0.8;
        }

        /* Responsive Fixes */
        @media (max-width: 480px) {
            .header-content { flex-direction: column; text-align: center; gap: 5px; }
            .timer-text-big { font-size: 2.5rem; }
            .parent-timer-circle { width: 160px; height: 160px; }
            .btn { font-size: 0.95rem; }
        }
        
        /* Finance Grid */
        .finance-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .finance-item { background: #f8f9fa; padding: 15px; border-radius: var(--radius-sm); text-align: center; border: 1px solid #eee;}
        .finance-item h4 { margin: 0 0 5px; color: #b2bec3; font-size: 0.8rem; }
        .finance-item .money { color: #00b894; font-weight: 800; font-size: 1.1rem; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <img src="https://raw.githubusercontent.com/mohamednasr5/opera/main/01.png" alt="Logo" style="width:110px; margin-bottom:20px; border-radius: 50%; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border: 4px solid white;">
            <h2 style="margin: 0; color: #333; font-weight: 800;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ğŸ‘‹</h2>
            <p style="color:#666; margin: 5px 0 20px;">Ù†Ø¸Ø§Ù… Ø§Ø³ØªØ¶Ø§ÙØ© Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ±</p>
            <input type="password" id="login-pass" class="login-input" placeholder="****" onkeypress="handleEnter(event)">
            <button class="btn btn-primary" style="font-size: 1.1rem; padding: 15px;" onclick="checkLogin()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… ğŸš€</button>
        </div>
    </div>

    <header>
        <div class="header-top">
            <span style="font-family: monospace; font-weight: bold;">ğŸ“… <span id="header-datetime">...</span></span>
            <div id="admin-controls" style="display:flex; gap:10px;">
                <button id="nav-stats-btn" class="btn btn-success hidden" style="padding: 4px 12px; font-size: 0.8rem;" onclick="openFinanceModal()">
                    <i class="fas fa-chart-pie"></i> Ù…Ù„Ø®Øµ
                </button>
                <button id="nav-logout-btn" class="btn btn-danger hidden" style="padding: 4px 12px; font-size: 0.8rem;" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>
        <div class="header-content">
            <img src="https://raw.githubusercontent.com/mohamednasr5/opera/main/01.png" alt="Opera Ashour Logo" class="logo-img">
            <div class="header-text">
                <h1>Ø§Ø³ØªØ¶Ø§ÙØ© Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ± ğŸª</h1>
                <p id="header-subtitle">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø°ÙƒÙŠ</p>
            </div>
        </div>
    </header>

    <main id="app">
        
        <div id="admin-view" class="hidden">
            <div class="dashboard-grid">
                
                <section class="card">
                    <h2 style="margin-bottom: 1.5rem; color: var(--primary-color); display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-user-plus"></i> ØªØ³Ø¬ÙŠÙ„ Ø·ÙÙ„ Ø¬Ø¯ÙŠØ¯
                    </h2>
                    <form id="checkin-form">
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„</label>
                            <input type="text" id="child-name" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§..." required>
                        </div>
                        <div class="form-group">
                            <label>Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„ÙˆØ§Ù„Ø¯</label>
                            <input type="tel" id="parent-phone" class="form-control" placeholder="01xxxxxxxxx" required>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <div class="form-group" style="flex: 2;">
                                <label>Ø¥Ø¶Ø§ÙØ§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                                <input type="text" id="extra-item" class="form-control" placeholder="Ù…Ø«Ù„Ø§Ù‹: ÙØ´Ø§Ø±">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Ø§Ù„Ø³Ø¹Ø±</label>
                                <input type="number" id="extra-price" class="form-control" placeholder="Ø¬.Ù…">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check-circle"></i> ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
                        </button>
                    </form>

                    <div id="new-child-qr" class="hidden text-center" style="margin-top: 2rem; background: #f8f9fa; padding: 20px; border-radius: var(--radius-md); border: 2px dashed #dcdde1;">
                        <h3 style="color: #00b894; margin:0 0 10px;">âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!</h3>
                        <p id="qr-parent-name" style="font-weight:bold; margin-bottom:15px; color: var(--dark-text);"></p>
                        <div id="qr-code" style="display:flex; justify-content:center; margin: 15px 0; padding: 10px; background: white; border-radius: 10px; display: inline-block;"></div>
                        
                        <a id="test-link-btn" class="test-link" target="_blank" style="display: block; margin: 10px 0; color: var(--primary-color); font-weight: bold; cursor: pointer;">ØªØ¬Ø±Ø¨Ø© ØµÙØ­Ø© Ø§Ù„ÙˆØ§Ù„Ø¯</a>

                        <div style="display:grid; gap:10px; margin-top:15px;">
                            <button class="btn btn-primary" onclick="copyLink()"><i class="fas fa-copy"></i> Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
                            <button class="btn btn-whatsapp" id="wa-btn-new"><i class="fab fa-whatsapp"></i> Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</button>
                            <button class="btn btn-outline" onclick="closeQR()">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                </section>

                <section>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="admin-search" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„Ø±Ù‚Ù…...)">
                    </div>

                    <div class="card" style="padding: 15px;">
                        <h2 class="section-title">Ø§Ù„Ø£Ø·ÙØ§Ù„ Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</h2>
                        <div id="kids-list-active"></div>
                    </div>

                    <div class="card" style="background: rgba(255,255,255,0.5); border: 1px dashed #b2bec3;">
                        <h2 class="section-title" style="color: #636e72; border-color: #b2bec3;">Ø³Ø¬Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬ (Ø§Ù„Ø£Ø­Ø¯Ø«)</h2>
                        <div id="kids-list-history"></div>
                    </div>
                </section>
            </div>
        </div>

        <div id="financial-view" class="hidden">
            <div class="card" style="text-align: center; background: linear-gradient(135deg, #2d3436 0%, #636e72 100%); color: white;">
                <h2 style="color: #dfe6e9; margin-bottom: 10px;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„ÙƒØ§Ø´</h2>
                <div class="big-number" id="grand-total-display" style="font-size: 3.5rem; font-weight: 800; color: #55efc4; text-shadow: 0 4px 10px rgba(0,0,0,0.3);">0 Ø¬.Ù…</div>
            </div>
            <div id="financial-logs" style="margin-top: 20px;"></div>
        </div>

        <div id="parent-view" class="hidden">
            <div class="parent-view-container">
                <div id="three-scene-container"></div> <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† 3D -->

                <div style="padding: 1rem; flex-grow: 1;">
                    <div class="parent-view-card">
                        <div class="status-badge-in" id="p-status-badge" style="background: #00b894; color: white; padding: 5px 15px; border-radius: 20px; display: inline-block; font-weight: bold; margin-bottom: 10px;">Ù…ØªÙˆØ§Ø¬Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹</div>
                        <h2 id="p-child-name" style="font-size:2.2rem; margin:0 0 5px; color:var(--dark-text);">Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„</h2>
                        
                        <p id="p-child-snack" style="color: #636e72; font-size:1rem; margin-bottom:20px; background: #f1f2f6; display: inline-block; padding: 5px 15px; border-radius: 15px;"></p>
                        
                        <div class="parent-timer-circle">
                            <div class="child-number-display" id="p-child-id">#0000</div>
                            <div class="timer-text-big" id="live-timer">00:00:00</div>
                        </div>
                        
                        <p style="color:#636e72; margin-top:10px;">ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„: <span id="entry-time-display" style="font-weight:bold; color: var(--primary-color);"></span></p>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 20px; margin: 20px 0;">
                            <h3 style="color:var(--dark-text); font-size:1.2rem; margin:0;">
                                Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="live-cost" style="color: var(--primary-color); font-size: 1.8rem;">0</span> Ø¬.Ù…
                            </h3>
                        </div>

                        <div class="chat-container">
                            <div id="parent-chat-messages" class="chat-messages">
                                <div style="text-align:center; color:#999; font-size:0.8rem; margin-top: auto;">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ğŸ’¬</div>
                            </div>
                            <div class="chat-input-area">
                                <input type="text" id="parent-message-input" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                                <button class="btn btn-primary" onclick="sendParentMessage()" style="border-radius: 10px; width: 50px; padding: 0;">
                                    <i class="fas fa-paper-plane"></i>
                                    <span id="parent-msg-badge" class="hidden notification-badge" style="background: red; color: white; border-radius: 50%; width: 15px; height: 15px; position: absolute; top: 5px; right: 5px; font-size: 10px;"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="session-ended-card" class="parent-view-card hidden" style="border: 2px solid #fab1a0;">
                        <div style="font-size: 4rem; margin-bottom: 10px;">ğŸˆ</div>
                        <h2 style="color:var(--dark-text); margin-bottom:10px;">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ…!</h2>
                        <p style="font-size:1.1rem; color:#636e72;">ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø¬Ø§Ø­.</p>
                        <div style="margin: 30px 0; background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);">
                            <span style="display: block; color: #b2bec3; font-size: 0.9rem;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</span>
                            <span id="final-cost" style="color: var(--primary-color); font-size: 3rem; font-weight: 800;">0</span>
                            <span style="color: var(--primary-color); font-weight: bold; font-size: 1.2rem;">Ø¬.Ù…</span>
                        </div>
                        <p style="color: var(--primary-color); font-weight: bold;">Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ± .. Ù…ÙƒØ§Ù† Ø§Ù„Ø³Ø¹Ø§Ø¯Ø© â¤ï¸</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div class="developer-footer">
        <p style="margin: 0 0 5px; color: #636e72;">ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© <span style="color: #e84393;">Eng. Mohamed Hammad</span></p>
        <div style="display: flex; gap: 15px; justify-content: center;">
            <a href="tel:01279934735"><i class="fas fa-phone"></i> 01279934735</a>
            <a href="https://www.facebook.com/en.mohamed.nasr" target="_blank"><i class="fab fa-facebook"></i> ÙÙŠØ³Ø¨ÙˆÙƒ</a>
        </div>
    </div>

    <div id="admin-chat-modal" class="modal">
        <div class="modal-content modal-chat-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <h3 id="chat-modal-title" style="margin:0;">Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
                <button onclick="closeAdminChat()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color: #636e72;">&times;</button>
            </div>
            <div id="admin-chat-history" class="chat-messages" style="flex:1; background: #f1f2f6; border-radius: 10px;"></div>
            <div class="chat-input-area" style="border:none; padding-top: 15px;">
                <input type="text" id="admin-chat-input" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯...">
                <button class="btn btn-primary" onclick="sendAdminMessage()" style="width: auto; padding: 0 20px;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="finance-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom:20px; text-align: center;">ğŸ“Š Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹</h2>
            <div class="finance-grid">
                <div class="finance-item">
                    <h4>Ø§Ù„ÙŠÙˆÙ…</h4>
                    <div class="money" id="stat-today">0</div>
                </div>
                <div class="finance-item">
                    <h4>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h4>
                    <div class="money" id="stat-week">0</div>
                </div>
                <div class="finance-item">
                    <h4>Ø§Ù„Ø´Ù‡Ø±</h4>
                    <div class="money" id="stat-month">0</div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="closeFinanceModal()" style="margin-top:20px;">ØªÙ…</button>
        </div>
    </div>

    <div id="checkout-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div style="width: 60px; height: 60px; background: #ff7675; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 1.5rem;">
                <i class="fas fa-sign-out-alt"></i>
            </div>
            <h2 style="margin-bottom: 5px;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ</h2>
            <p style="color: #636e72;">Ù…Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨: <span id="modal-duration" style="font-weight:bold; font-family:monospace; color: var(--dark-text);"></span></p>
            
            <div style="background: #f1f2f6; padding: 20px; border-radius: 15px; margin: 20px 0;">
                <div style="font-size:2.5rem; font-weight:800; color:var(--primary-color);" id="modal-price">0 Ø¬.Ù…</div>
                <p style="font-size:0.85rem; color:#b2bec3; margin: 5px 0 0;">(Ø§Ù„Ø³Ø¹Ø± ÙŠØ´Ù…Ù„ Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ§Øª)</p>
            </div>
            
            <div style="display:flex; gap:10px;">
                <button class="btn btn-danger" onclick="confirmCheckout()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                <button class="btn btn-outline" onclick="closeModal()">ØªØ±Ø§Ø¬Ø¹</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    
    <audio id="msg-sound" src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_3f32527b79.mp3"></audio>
    <audio id="hour-sound" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_12b0c7443c.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, set, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDIH-wzZV71U-zbkxArRE4f9oiCtwvKOWA",
          authDomain: "operaestdafa.firebaseapp.com",
          databaseURL: "https://operaestdafa-default-rtdb.firebaseio.com",
          projectId: "operaestdafa",
          storageBucket: "operaestdafa.firebasestorage.app",
          messagingSenderId: "44885598287",
          appId: "1:44885598287:web:e2b0d3497b86c69de38a3a",
          measurementId: "G-X1129EKN1P"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Same Logic as Original File ---
        const msgSound = document.getElementById('msg-sound');
        const hourSound = document.getElementById('hour-sound');

        function requestNotifyPermission() {
            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        }

        function sendBrowserNotification(title, body) {
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(title, { body: body, icon: 'https://raw.githubusercontent.com/mohamednasr5/opera/main/01.png' });
            }
        }

        function playSound(type) {
            if(type === 'msg') {
                msgSound.currentTime = 0;
                msgSound.play().catch(e => console.log("Audio play failed", e));
            } else if (type === 'hour') {
                hourSound.currentTime = 0;
                hourSound.play().catch(e => console.log("Audio play failed", e));
            }
        }

        let currentChildId = null;
        let currentChildLink = "";
        let parentInterval = null;
        let adminTimerInterval = null;
        let allChildrenData = {};
        let currentChatId = null; 
        let lastMessageCounts = {}; 
        let searchQuery = ""; 
        
        const adminView = document.getElementById('admin-view');
        const financialView = document.getElementById('financial-view');
        const parentView = document.getElementById('parent-view');
        const loginScreen = document.getElementById('login-screen');
        const listActive = document.getElementById('kids-list-active');
        const listHistory = document.getElementById('kids-list-history');
        const qrContainer = document.getElementById('qr-code');
        const searchInput = document.getElementById('admin-search');

        searchInput.addEventListener('input', (e) => {
            searchQuery = e.target.value.toLowerCase();
            filterAdminList();
        });

        function filterAdminList() {
            const cards = document.querySelectorAll('#kids-list-active .kid-card');
            cards.forEach(card => {
                const name = card.getAttribute('data-name').toLowerCase();
                const phone = card.getAttribute('data-phone').toLowerCase();
                const id = card.getAttribute('data-id');
                
                if(name.includes(searchQuery) || phone.includes(searchQuery) || id === searchQuery) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function handleEnter(e) { if(e.key === 'Enter') checkLogin(); }
        window.handleEnter = handleEnter;

        window.checkLogin = () => {
            requestNotifyPermission(); 
            const pass = document.getElementById('login-pass').value;
            if(pass === '0100') {
                loginScreen.classList.add('hidden');
                document.getElementById('nav-stats-btn').classList.add('hidden'); 
                document.getElementById('nav-logout-btn').classList.remove('hidden');
                document.getElementById('admin-controls').style.display = 'flex'; 
                initAdminView();
            } else if (pass === '521988') {
                loginScreen.classList.add('hidden');
                document.getElementById('nav-stats-btn').classList.add('hidden'); 
                document.getElementById('nav-logout-btn').classList.remove('hidden');
                document.getElementById('admin-controls').style.display = 'flex';
                initFinancialView();
            } else {
                showToast("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©! âŒ");
                document.getElementById('login-pass').value = '';
            }
        };

        window.logout = () => {
            location.reload();
        };

        const urlParams = new URLSearchParams(window.location.search);
        const viewMode = urlParams.get('mode');
        const childIdParam = urlParams.get('id');

        if (viewMode === 'parent' && childIdParam) {
            loginScreen.classList.add('hidden');
            document.getElementById('admin-controls').style.display = 'none'; 
            document.getElementById('header-subtitle').innerText = "Ø¨ÙˆØ§Ø¨Ø© Ù…ØªØ§Ø¨Ø¹Ø© Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±";
            requestNotifyPermission();
            initParentView(childIdParam);
        }

        setInterval(() => {
            document.getElementById('header-datetime').innerText = new Date().toLocaleDateString('ar-EG', { weekday:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
        }, 1000);

        function initAdminView() {
            adminView.classList.remove('hidden');
            document.getElementById('header-subtitle').innerText = "Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©";
            
            onValue(ref(db, 'children'), (snapshot) => {
                const data = snapshot.val();
                allChildrenData = data || {};
                listActive.innerHTML = '';
                listHistory.innerHTML = '';
                if (!data) listActive.innerHTML = '<p style="text-align:center; color:#999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø·ÙØ§Ù„</p>';

                Object.keys(data).forEach(key => {
                    const child = data[key];
                    const link = `${window.location.origin}${window.location.pathname}?mode=parent&id=${key}`;
                    let billableTime = 0;
                    
                    let productText = '';
                    if(child.productName) {
                        productText = `<span class="kid-tag" style="background:#dfe6e9; color:#2d3436;">ğŸ›’ ${child.productName} (${child.productPrice || 0})</span>`;
                    }

                    if (child.status === 'in') {
                        billableTime = Date.now() - child.entryTime - (child.totalPausedTime || 0);
                        const div = document.createElement('div');
                        div.className = 'kid-card in-status';
                        div.setAttribute('data-name', child.name);
                        div.setAttribute('data-phone', child.phone);
                        div.setAttribute('data-id', child.childId || '');

                        const msgs = child.messages ? Object.values(child.messages) : [];
                        const msgCount = msgs.length;
                        const lastCount = lastMessageCounts[key] || 0;
                        
                        if (msgCount > lastCount) {
                             const lastMsg = msgs[msgs.length - 1];
                             if (lastMsg.sender === 'parent') {
                                 playSound('msg');
                                 sendBrowserNotification(`Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù†: ${child.name}`, lastMsg.text);
                                 showToast(`ğŸ“© Ø±Ø³Ø§Ù„Ø© Ù…Ù† ${child.name}`);
                             }
                        }
                        lastMessageCounts[key] = msgCount;
                        const badgeHtml = msgCount > 0 ? `<span style="background:red; color:white; border-radius:50%; padding:2px 6px; font-size:0.7rem; position:absolute; top:-5px; right:-5px;">${msgCount}</span>` : '';

                        div.innerHTML = `
                            <div class="kid-info">
                                <h3>${child.name} <span class="kid-id-badge">#${child.childId || '00'}</span></h3>
                                <div class="kid-meta">
                                    <span class="kid-tag">ğŸ“± ${child.phone}</span>
                                    ${productText}
                                </div>
                                <div class="timer-display">â±ï¸ <span class="time-text" data-name="${child.name}" data-billable="${billableTime}" data-last-hour="0">${formatDuration(billableTime)}</span></div>
                            </div>
                            <div class="controls">
                                <button class="btn btn-whatsapp" onclick="sendToWhatsApp('${child.phone}', '${encodeURIComponent(link)}')"><i class="fab fa-whatsapp"></i></button>
                                <button class="btn btn-warning" onclick="pauseChild('${key}')" title="Ø®Ø±ÙˆØ¬ Ù…Ø¤Ù‚Øª"><i class="fas fa-pause"></i></button>
                                <button class="btn btn-primary" style="position:relative;" onclick="openAdminChat('${key}', '${child.name}')" title="Ù…Ø­Ø§Ø¯Ø«Ø©">
                                    <i class="fas fa-comments"></i> ${badgeHtml}
                                </button>
                                <button class="btn btn-danger" onclick="prepareCheckout('${key}')">Ø®Ø±ÙˆØ¬</button>
                            </div>
                        `;
                        listActive.appendChild(div);
                    } else if (child.status === 'paused') {
                        billableTime = child.pauseStartTime - child.entryTime - (child.totalPausedTime || 0);
                        const div = document.createElement('div');
                        div.className = 'kid-card paused-status';
                        div.setAttribute('data-name', child.name);
                        div.setAttribute('data-phone', child.phone);
                        div.setAttribute('data-id', child.childId || '');
                        
                        div.innerHTML = `
                            <div class="kid-info">
                                <h3>${child.name} <span class="kid-id-badge">#${child.childId || '00'}</span></h3>
                                <div class="kid-meta"><span class="kid-tag" style="background:#ffeaa7;">â¸ï¸ Ù…Ø¤Ù‚Øª</span> ${productText}</div>
                                <div class="timer-display timer-paused">${formatDuration(billableTime)}</div>
                            </div>
                            <div class="controls">
                                <button class="btn btn-success" style="color:white;" onclick="resumeChild('${key}')">â–¶ï¸ Ø§Ø³ØªÙƒÙ…Ø§Ù„</button>
                                <button class="btn btn-danger" onclick="prepareCheckout('${key}')">Ø®Ø±ÙˆØ¬ Ù†Ù‡Ø§Ø¦ÙŠ</button>
                            </div>
                        `;
                        listActive.appendChild(div);
                    } else {
                        const diff = child.exitTime - child.entryTime - (child.totalPausedTime || 0);
                        const div = document.createElement('div');
                        div.className = 'kid-card out-status';
                        div.innerHTML = `
                            <div class="kid-info">
                                <h3 style="color:#b2bec3;">${child.name} <span class="kid-id-badge">#${child.childId || '00'}</span></h3>
                                <div class="kid-meta">
                                    <span class="kid-tag">ğŸ“… ${new Date(child.exitTime).toLocaleTimeString('ar-EG')}</span>
                                    ${productText}
                                </div>
                                <div style="font-weight:bold; color:#00b894;">ğŸ’° ${child.totalCost} Ø¬.Ù…</div>
                            </div>
                        `;
                        listHistory.appendChild(div);
                    }
                });
                
                filterAdminList();
            });

            if(adminTimerInterval) clearInterval(adminTimerInterval);
            adminTimerInterval = setInterval(() => {
                document.querySelectorAll('.time-text').forEach(el => {
                    let t = parseInt(el.getAttribute('data-billable')) + 1000;
                    el.setAttribute('data-billable', t);
                    el.innerText = formatDuration(t);

                    const currentHour = Math.floor(t / 3600000); 
                    const lastHour = parseInt(el.getAttribute('data-last-hour'));
                    const childName = el.getAttribute('data-name');
                    
                    if (currentHour > lastHour) {
                        playSound('hour');
                        sendBrowserNotification("Ù…Ø±ÙˆØ± Ø³Ø§Ø¹Ø© â°", `Ø£ØªÙ… Ø§Ù„Ø·ÙÙ„ ${childName} Ø³Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©.`);
                        showToast(`â° Ù…Ø± Ø³Ø§Ø¹Ø© Ù„Ù„Ø·ÙÙ„: ${childName}`);
                        el.setAttribute('data-last-hour', currentHour);
                    }
                });
            }, 1000);

            document.getElementById('checkin-form').onsubmit = (e) => {
                e.preventDefault();
                const name = document.getElementById('child-name').value;
                const phone = document.getElementById('parent-phone').value;
                const productName = document.getElementById('extra-item').value;
                const productPrice = parseFloat(document.getElementById('extra-price').value) || 0;

                const randomId = Math.floor(1000 + Math.random() * 9000).toString();
                const newRef = push(ref(db, 'children'));
                const link = `${window.location.origin}${window.location.pathname}?mode=parent&id=${newRef.key}`;
                
                set(newRef, {
                    name, phone, 
                    productName: productName, 
                    productPrice: productPrice, 
                    entryTime: Date.now(), status:'in', messages:[], totalPausedTime:0,
                    childId: randomId
                }).then(() => {
                    showToast(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${name}`);
                    document.getElementById('child-name').value = '';
                    document.getElementById('parent-phone').value = '';
                    document.getElementById('extra-item').value = '';
                    document.getElementById('extra-price').value = '';
                    
                    currentChildLink = link;
                    document.getElementById('new-child-qr').classList.remove('hidden');
                    document.getElementById('qr-parent-name').innerText = `${name} - Ø±Ù‚Ù…: ${randomId}`;
                    qrContainer.innerHTML = '';
                    new QRCode(qrContainer, { text: link, width:128, height: 128 });
                    document.getElementById('test-link-btn').href = link;
                    document.getElementById('wa-btn-new').onclick = () => sendToWhatsApp(phone, encodeURIComponent(link));
                });
            };
        }

        window.openAdminChat = (id, name) => {
            currentChatId = id;
            document.getElementById('chat-modal-title').innerText = `Ù…Ø­Ø§Ø¯Ø«Ø©: ${name}`;
            document.getElementById('admin-chat-modal').style.display = 'flex';
            document.getElementById('admin-chat-input').focus();
            const chatRef = ref(db, `children/${id}/messages`);
            onValue(chatRef, (snapshot) => {
                const messages = snapshot.val();
                const historyEl = document.getElementById('admin-chat-history');
                historyEl.innerHTML = '';
                if(!messages) return;
                Object.values(messages).sort((a,b) => a.timestamp - b.timestamp).forEach(msg => {
                    const div = document.createElement('div');
                    div.className = `message ${msg.sender}`;
                    const senderName = msg.sender === 'admin' ? 'Ø£Ù†Øª' : 'Ø§Ù„ÙˆØ§Ù„Ø¯';
                    div.innerHTML = `<span style="font-size:0.7rem; opacity:0.6; display:block;">${senderName}</span>${msg.text}`;
                    historyEl.appendChild(div);
                });
                historyEl.scrollTop = historyEl.scrollHeight;
            });
        };

        window.closeAdminChat = () => {
            document.getElementById('admin-chat-modal').style.display = 'none';
            currentChatId = null;
        };

        window.sendAdminMessage = () => {
            const input = document.getElementById('admin-chat-input');
            const text = input.value.trim();
            if(!text || !currentChatId) return;
            push(ref(db, `children/${currentChatId}/messages`), { text: text, sender: 'admin', timestamp: Date.now() });
            input.value = '';
        };

        function initFinancialView() {
            financialView.classList.remove('hidden');
            document.getElementById('header-subtitle').innerText = "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©";
            const logsContainer = document.getElementById('financial-logs');
            logsContainer.innerHTML = '<div style="text-align:center; padding:20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

            get(ref(db, 'children')).then((snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    logsContainer.innerHTML = '<div style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</div>';
                    return;
                }
                const records = {}; 
                let grandTotal = 0;
                Object.keys(data).forEach(key => {
                    const child = data[key];
                    if (child.status === 'out' && child.exitTime) {
                        const cost = parseFloat(child.totalCost);
                        const dateObj = new Date(child.exitTime);
                        const dateKey = `${dateObj.getFullYear()}-${dateObj.getMonth()+1}-${dateObj.getDate()}`; 
                        const dateDisplay = dateObj.toLocaleDateString('ar-EG', { weekday:'long', day:'numeric', month:'long' });
                        const exitTime = dateObj.toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
                        if (!records[dateKey]) { records[dateKey] = { display: dateDisplay, total: 0, items: [] }; }
                        records[dateKey].items.push({ name: child.name, cost: cost, time: exitTime });
                        records[dateKey].total += cost;
                        grandTotal += cost;
                    }
                });
                document.getElementById('grand-total-display').innerText = grandTotal.toFixed(1) + ' Ø¬.Ù…';
                logsContainer.innerHTML = '';
                
                Object.keys(records).sort((a,b) => new Date(b) - new Date(a)).forEach(date => {
                    const dayData = records[date];
                    const dayHtml = document.createElement('div');
                    dayHtml.className = 'card';
                    let itemsHtml = '';
                    dayData.items.forEach(item => {
                        itemsHtml += `
                            <div style="padding: 10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                                <div>
                                    <span style="font-weight:bold;">${item.name}</span>
                                    <span style="font-size:0.8rem; color:#999; display:block;">${item.time}</span>
                                </div>
                                <span style="font-weight:bold; color:#00b894;">${item.cost} Ø¬.Ù…</span>
                            </div>`;
                    });
                    dayHtml.innerHTML = `
                        <div style="background:#f1f2f6; padding:10px; border-radius:5px; margin-bottom:10px; font-weight:bold;">ğŸ“… ${dayData.display}</div>
                        ${itemsHtml}
                        <div style="text-align:right; padding-top:10px; font-weight:bold;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…: ${dayData.total.toFixed(1)} Ø¬.Ù…</div>`;
                    logsContainer.appendChild(dayHtml);
                });
            });
        }

        window.pauseChild = (id) => update(ref(db, `children/${id}`), { status:'paused', pauseStartTime: Date.now() });
        window.resumeChild = (id) => {
            get(ref(db, `children/${id}`)).then(snap => {
                const d = snap.val();
                const pauseDur = Date.now() - d.pauseStartTime;
                update(ref(db, `children/${id}`), { status:'in', totalPausedTime: (d.totalPausedTime||0) + pauseDur });
            });
        };
        
        window.prepareCheckout = (id) => {
            currentChildId = id;
            get(ref(db, `children/${id}`)).then(s => {
                const c = s.val();
                let bill = c.status === 'paused' ? c.pauseStartTime - c.entryTime - (c.totalPausedTime||0) : Date.now() - c.entryTime - (c.totalPausedTime||0);
                
                const timeCost = calculateTimeCost(bill);
                const extra = c.productPrice || 0;
                const total = (parseFloat(timeCost) + parseFloat(extra)).toFixed(1);

                document.getElementById('modal-duration').innerText = formatDuration(bill);
                document.getElementById('modal-price').innerHTML = total + ' Ø¬.Ù…';
                document.getElementById('checkout-modal').style.display = 'flex';
            });
        };

        window.confirmCheckout = () => {
            get(ref(db, `children/${currentChildId}`)).then(s => {
                const c = s.val();
                let bill = c.status === 'paused' ? c.pauseStartTime - c.entryTime - (c.totalPausedTime||0) : Date.now() - c.entryTime - (c.totalPausedTime||0);
                
                const timeCost = calculateTimeCost(bill);
                const extra = c.productPrice || 0;
                const total = (parseFloat(timeCost) + parseFloat(extra)).toFixed(1);

                update(ref(db, `children/${currentChildId}`), { status:'out', exitTime: Date.now(), totalCost: total });
                closeModal();
                showToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
            });
        };

        window.closeModal = () => document.getElementById('checkout-modal').style.display = 'none';
        window.closeQR = () => document.getElementById('new-child-qr').classList.add('hidden');
        window.copyLink = () => { navigator.clipboard.writeText(currentChildLink); showToast("ØªÙ… Ø§Ù„Ù†Ø³Ø®"); };
        window.sendToWhatsApp = (phone, link) => { window.open(`https://wa.me/${phone.replace(/[^0-9]/g,'')}?text=${encodeURIComponent('Ø±Ø§Ø¨Ø· Ù…ØªØ§Ø¨Ø¹Ø© Ø·ÙÙ„Ùƒ: '+decodeURIComponent(link))}`, '_blank'); };

        window.openFinanceModal = () => {
            const now = new Date();
            const startDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const startWeek = startDay - (6*86400000);
            const startMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            let d=0, w=0, m=0;
            Object.keys(allChildrenData).forEach(k => {
                const c = allChildrenData[k];
                if(c.status==='out' && c.exitTime) {
                    const cost = parseFloat(c.totalCost);
                    if(c.exitTime >= startDay) d += cost;
                    if(c.exitTime >= startWeek) w += cost;
                    if(c.exitTime >= startMonth) m += cost;
                }
            });
            document.getElementById('stat-today').innerText = d.toFixed(1);
            document.getElementById('stat-week').innerText = w.toFixed(1);
            document.getElementById('stat-month').innerText = m.toFixed(1);
            document.getElementById('finance-modal').style.display = 'flex';
        };
        window.closeFinanceModal = () => document.getElementById('finance-modal').style.display = 'none';

        function initParentView(id) {
            adminView.classList.add('hidden');
            financialView.classList.add('hidden');
            parentView.classList.remove('hidden');
            
            let prevMsgCount = 0;
            
            onValue(ref(db, `children/${id}/messages`), (snapshot) => {
                const messages = snapshot.val();
                const container = document.getElementById('parent-chat-messages');
                container.innerHTML = '';
                let currentCount = 0;
                let msgsArray = [];
                if (messages) {
                    msgsArray = Object.values(messages).sort((a,b) => a.timestamp - b.timestamp);
                    msgsArray.forEach(msg => {
                        const div = document.createElement('div');
                        div.className = `message ${msg.sender === 'admin' ? 'admin' : 'parent'}`;
                        const senderName = msg.sender === 'admin' ? 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©' : 'Ø£Ù†Øª';
                        div.innerHTML = `<span style="font-size:0.7rem; opacity:0.6; display:block;">${senderName}</span>${msg.text}`;
                        container.appendChild(div);
                        currentCount++;
                    });
                }
                if (currentCount > prevMsgCount && currentCount > 0) {
                    const lastMsg = msgsArray[msgsArray.length - 1];
                    if (lastMsg.sender === 'admin') {
                        playSound('msg');
                        sendBrowserNotification("Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ğŸ’¬", lastMsg.text);
                        showToast("ğŸ“© Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©");
                    }
                }
                const badge = document.getElementById('parent-msg-badge');
                if(currentCount > 0) {
                    badge.innerText = currentCount;
                    badge.classList.remove('hidden');
                } else { badge.classList.add('hidden'); }

                prevMsgCount = currentCount;
                container.scrollTop = container.scrollHeight;
            });

            onValue(ref(db, `children/${id}`), s => {
                const c = s.val();
                if(!c) return;
                document.getElementById('p-child-id').innerText = '#' + (c.childId || '00');
                document.getElementById('p-child-name').innerText = c.name;
                
                let snackText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©";
                if(c.productName) {
                    snackText = `ğŸ›’ ${c.productName} (${c.productPrice} Ø¬.Ù…)`;
                }
                document.getElementById('p-child-snack').innerText = snackText;

                document.getElementById('entry-time-display').innerText = new Date(c.entryTime).toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});
                const badge = document.getElementById('p-status-badge');
                const timer = document.getElementById('live-timer');

                if(c.status === 'in') {
                    badge.innerText = 'Ù…ØªÙˆØ§Ø¬Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹';
                    badge.style.background = '#00b894';
                    document.querySelector('.parent-view-card').style.display='block';
                    document.getElementById('session-ended-card').classList.add('hidden');
                    if(parentInterval) clearInterval(parentInterval);
                    let lastHour = 0;
                    const updateTimer = () => {
                        const t = Date.now() - c.entryTime - (c.totalPausedTime||0);
                        timer.innerText = formatDuration(t);
                        
                        const timeCost = calculateTimeCost(t);
                        const extra = c.productPrice || 0;
                        const totalLive = (parseFloat(timeCost) + parseFloat(extra)).toFixed(1);
                        document.getElementById('live-cost').innerText = totalLive;

                        const currentHour = Math.floor(t / 3600000);
                        if (currentHour > lastHour) {
                            playSound('hour');
                            sendBrowserNotification("ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ÙˆÙ‚Øª â°", "Ù„Ù‚Ø¯ Ø£ØªÙ… Ø·ÙÙ„Ùƒ Ø³Ø§Ø¹Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨.");
                            lastHour = currentHour;
                        }
                    };
                    updateTimer(); 
                    parentInterval = setInterval(updateTimer, 1000);
                } else if (c.status === 'paused') {
                    clearInterval(parentInterval);
                    badge.innerText = 'Ø®Ø±ÙˆØ¬ Ù…Ø¤Ù‚Øª';
                    badge.style.background = '#fdcb6e';
                    const pausedT = c.pauseStartTime - c.entryTime - (c.totalPausedTime||0);
                    timer.innerText = formatDuration(pausedT);
                } else if (c.status === 'out') {
                    clearInterval(parentInterval);
                    document.querySelector('.parent-view-card').style.display='none';
                    document.getElementById('session-ended-card').classList.remove('hidden');
                    document.getElementById('final-cost').innerText = c.totalCost;
                }
            });
        }

        window.sendParentMessage = () => {
            const t = document.getElementById('parent-message-input').value;
            if(!t) return;
            push(ref(db, `children/${childIdParam}/messages`), { text:t, sender:'parent', timestamp:Date.now() });
            document.getElementById('parent-message-input').value = '';
        };

        function calculateTimeCost(ms) { 
            const hours = Math.ceil(ms / 3600000); 
            return (hours * 20); 
        }

        function formatDuration(ms) {
            const s = Math.floor((ms/1000)%60), m = Math.floor((ms/60000)%60), h = Math.floor(ms/3600000);
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }
        window.showToast = (m) => {
            const t = document.createElement('div'); 
            t.style.cssText = 'background:#2d3436; color:white; padding:12px 24px; border-radius:30px; margin-top:10px; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); z-index:2000; animation: popIn 0.3s; font-weight:bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2);';
            t.innerText = m;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        };

        // --- Ø¥Ø¶Ø§ÙØ© Ø£Ù†ÙŠÙ…ÙŠØ´Ù† 3D Ù…ØªØ­Ø±Ùƒ Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø£Ø·ÙØ§Ù„ Ù…Ø¹ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø§ÙˆØ³ ---
        function init3DScene() {
            const container = document.getElementById('three-scene-container');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true }); // Ø´ÙØ§ÙÙŠØ© Ù„Ù„Ø®Ù„ÙÙŠØ©
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            // Ø¥Ø¶Ø§ÙØ© Ø¶ÙˆØ¡
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(5, 5, 5);
            scene.add(light);
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);

            // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù„Ø¹Ø§Ø¨ Ø£Ø·ÙØ§Ù„ 3D Ø¨Ø³ÙŠØ·Ø©
            // 1. Merry-go-round (Ø¯ÙˆØ§Ø±Ø©)
            const merryGeometry = new THREE.CylinderGeometry(2, 2, 0.2, 32);
            const merryMaterial = new THREE.MeshBasicMaterial({ color: 0xff00ff });
            const merryGoRound = new THREE.Mesh(merryGeometry, merryMaterial);
            scene.add(merryGoRound);

            // 2. Swing (Ø£Ø±Ø¬ÙˆØ­Ø©)
            const swingPoleGeometry = new THREE.BoxGeometry(0.1, 3, 0.1);
            const swingPoleMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
            const swingPoleLeft = new THREE.Mesh(swingPoleGeometry, swingPoleMaterial);
            swingPoleLeft.position.set(-1, 1.5, 0);
            scene.add(swingPoleLeft);
            const swingPoleRight = new THREE.Mesh(swingPoleGeometry, swingPoleMaterial);
            swingPoleRight.position.set(1, 1.5, 0);
            scene.add(swingPoleRight);

            const swingSeatGeometry = new THREE.BoxGeometry(1, 0.2, 0.5);
            const swingSeatMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00 });
            const swingSeat = new THREE.Mesh(swingSeatGeometry, swingSeatMaterial);
            swingSeat.position.set(0, 0.1, 0);
            scene.add(swingSeat);

            // 3. Slide (Ø²Ù„Ø§Ø¬Ø©)
            const slideGeometry = new THREE.BoxGeometry(3, 0.1, 1);
            const slideMaterial = new THREE.MeshBasicMaterial({ color: 0x0000ff });
            const slide = new THREE.Mesh(slideGeometry, slideMaterial);
            slide.rotation.z = -Math.PI / 6; // Ø¥Ù…Ø§Ù„Ø©
            slide.position.set(3, 0.5, 0);
            scene.add(slide);

            camera.position.z = 5;

            // Ø¥Ø¶Ø§ÙØ© ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø§ÙˆØ³ (OrbitControls)
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.25;
            controls.screenSpacePanning = false;
            controls.maxPolarAngle = Math.PI / 2;

            // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù…ØªØ­Ø±Ùƒ
            function animate() {
                requestAnimationFrame(animate);

                // Ø­Ø±ÙƒØ© Ø§Ù„Ø¯ÙˆØ§Ø±Ø©
                merryGoRound.rotation.y += 0.01;

                // Ø­Ø±ÙƒØ© Ø§Ù„Ø£Ø±Ø¬ÙˆØ­Ø© (ØªØ£Ø±Ø¬Ø­)
                swingSeat.rotation.z = Math.sin(Date.now() * 0.001) * Math.PI / 6;

                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù… Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø§ÙØ°Ø©
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù€ 3D Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.addEventListener('DOMContentLoaded', init3DScene);
    </script>
</body>
</html>
