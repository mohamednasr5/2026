<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ø³ØªØ¶Ø§ÙØ© Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ± - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø·ÙˆØ±</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ø§Ù… --- */
        :root {
            --primary: #ff4757;
            --secondary: #2f3542;
            --accent: #1e90ff;
            --success: #2ed573;
            --warning: #ffa502;
            --bg-body: #e5ddd5; /* Ø®Ù„ÙÙŠØ© ÙˆØ§ØªØ³Ø§Ø¨ */
            --surface: #ffffff;
            --whatsapp: #25D366;
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background-color: #f0f2f5; color: var(--secondary); min-height: 100vh; display: flex; flex-direction: column; font-size: 16px; overflow-x: hidden; }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        header { background: rgba(255, 255, 255, 0.98); padding: 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .header-top { background: var(--secondary); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;}
        
        .logout-btn-styled {
            background-color: var(--primary); color: white !important; border: none; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.3s;
        }
        .logout-btn-styled:hover { background-color: #ff6b81; transform: translateY(-2px); }

        .header-content { padding: 15px 20px; display: flex; align-items: center; gap: 20px; max-width: 1200px; margin: 0 auto;}
        .logo-img { height: 60px; width: 60px; background: white; border-radius: 50%; padding: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid #fff;}
        
        /* --- Ø§Ù„Ø¨Ø­Ø« --- */
        .search-box { background: white; padding: 0.8rem 1.2rem; border-radius: 50px; margin-bottom: 1.5rem; display: flex; gap: 15px; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 2px solid #e1e1e1; }
        .search-box input { border: none; flex: 1; outline: none; font-size: 1rem; color: #333; }
        .search-box i { color: var(--secondary); font-size: 1.1rem; }

        /* --- Ø§Ù„Ø£Ø²Ø±Ø§Ø± --- */
        .btn { padding: 10px 15px; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 1rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; color: var(--secondary); background: #fff; border: 1px solid #eee; }
        .btn i { font-size: 1.1rem; }
        .btn-danger { background-color: #ff4757 !important; color: white !important; border: none !important; }
        .btn-primary { background-color: #2f3542 !important; color: white !important; border: none !important; }
        .btn-warning { background-color: #ffa502 !important; color: white !important; border: none !important; }
        .btn-success { background-color: #2ed573 !important; color: white !important; border: none !important; }
        .btn-whatsapp { background-color: #25D366 !important; color: white !important; border: none !important; }
        .btn-purple { background-color: #a55eea !important; color: white !important; border: none !important; }
        .btn-outline { background-color: transparent !important; border: 2px solid #ccc !important; color: #555 !important; }
        .btn-info { background-color: var(--accent) !important; color: white !important; border: none !important; }

        /* Login */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #ff9ff3 0%, #feca57 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-card { background: rgba(255, 255, 255, 0.95); padding: 3rem 2rem; border-radius: 24px; width: 90%; max-width: 420px; text-align: center; }
        .login-input { width: 100%; padding: 18px; background: #f7f9fc; border-radius: 12px; font-size: 1.3rem; text-align: center; margin: 2rem 0; letter-spacing: 8px; font-weight: bold; border: 2px solid transparent;}

        /* Layout */
        main { flex: 1; padding: 2rem 1rem; max-width: 1200px; margin: 0 auto; width: 100%; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 992px) { .dashboard-grid { grid-template-columns: 380px 1fr; } }
        
        .card { background: var(--surface); border-radius: var(--radius); padding: 1.8rem; box-shadow: 0 8px 24px rgba(149, 157, 165, 0.1); margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1.2rem; }
        .form-control { width: 100%; padding: 14px; background: #f8f9fa; border: 1px solid #dfe4ea; border-radius: 12px; font-size: 1rem; }
        select.form-control { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: left 1rem center; background-size: 1em; }

        .kid-card { background: white; border-radius: 16px; padding: 1.2rem; margin-bottom: 1rem; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); position: relative; overflow: hidden; border: 1px solid #f1f2f6;}
        .kid-card::before { content: ''; position: absolute; top: 0; right: 0; width: 6px; height: 100%; }
        .kid-card.in-status::before { background: var(--success); }
        .kid-card.paused-status::before { background: var(--warning); }
        .kid-card.out-status::before { background: #ccc; }
        @media (min-width: 600px) { .kid-card { flex-direction: row; justify-content: space-between; align-items: center; } }
        .kid-info h3 { font-size: 1.15rem; font-weight: 700; color: var(--secondary); display: flex; align-items: center; gap: 8px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 2rem; border-radius: 24px; width: 90%; max-width: 450px; }
        .hidden { display: none !important; }

        /* Receipt */
        .receipt-card { background: #fff; width: 100%; position: relative; overflow: hidden; }
        .receipt-header { background: var(--secondary); color: white; padding: 20px; text-align: center; border-bottom: 5px solid var(--primary); }
        .receipt-body { padding: 20px; background: #fff; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95rem; color: #555; }
        .receipt-row.bold { font-weight: bold; color: #000; font-size: 1.1rem; }
        .dashed-divider { border-bottom: 2px dashed #ccc; margin: 15px 0; position: relative; }
        .receipt-total-box { background: #f1f2f6; padding: 15px; text-align: center; border-radius: 10px; margin-top: 15px; }
        .timer-display { font-family: 'Courier New', monospace; font-weight: 800; color: var(--primary); font-size: 1.1rem; background: rgba(255, 71, 87, 0.05); padding: 5px 10px; border-radius: 8px; display: inline-block;}
        .pricing-badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 10px; background: #eee; color: #555; margin-right: 5px; }

        /* Financial */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 16px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; overflow: hidden; border: 1px solid #eee; }
        .stat-card h3 { color: #888; font-size: 0.9rem; margin-bottom: 10px; }
        .stat-card .value { font-size: 1.6rem; font-weight: 800; color: var(--secondary); }
        .stat-card.clickable { cursor: pointer; border: 2px solid transparent; transition: 0.3s; background: #fffdfd; }
        .stat-card.clickable:hover { border-color: var(--primary); transform: translateY(-5px); }
        .stat-card.income-card .value { color: var(--success); }
        .stat-card.product-card .value { color: var(--accent); }
        
        /* Parent View */
        .parent-view-card { text-align: center; border-radius: 30px; padding: 2rem 1.5rem; background: rgba(255, 255, 255, 0.95); margin-top: 2rem; position: relative; z-index: 10; box-shadow: 0 20px 50px rgba(0,0,0,0.08); }
        .parent-timer-circle { width: 180px; height: 180px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin: 20px auto; border: 8px solid rgba(255, 71, 87, 0.1); }
        .timer-text-big { font-size: 2.5rem; font-weight: 900; color: var(--secondary); }
        .paused-text-msg { color: var(--warning); font-weight: bold; font-size: 1.2rem; line-height: 1.6; }
        .scene-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%); pointer-events: none; }
        
        /* --- WhatsApp Chat Style --- */
        .chat-container { margin-top: 1.5rem; background: #e5ddd5; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); /* Ø®Ù„ÙÙŠØ© ÙˆØ§ØªØ³Ø§Ø¨ */ }
        .chat-messages { height: 350px; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        
        .message { padding: 8px 12px; border-radius: 8px; max-width: 75%; font-size: 0.95rem; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); display: flex; flex-direction: column; min-width: 100px; }
        
        /* Ø±Ø³Ø§Ù„Ø© Ù…Ø³ØªÙ„Ù…Ø© (Ø£Ø¨ÙŠØ¶) */
        .message.received { align-self: flex-start; background: white; color: #111; border-top-left-radius: 0; }
        .message.received::after { content: ''; position: absolute; top: 0; right: -10px; width: 0; height: 0; border: 10px solid transparent; border-top-color: white; border-left: 0; border-right: 0; margin-top: 0; margin-right: -10px; transform: rotate(180deg); right: auto; left: -8px;}

        /* Ø±Ø³Ø§Ù„Ø© Ù…Ø±Ø³Ù„Ø© (Ø£Ø®Ø¶Ø± ÙØ§ØªØ­) */
        .message.sent { align-self: flex-end; background: #dcf8c6; color: #111; border-top-right-radius: 0; }
        .message.sent::after { content: ''; position: absolute; top: 0; right: -8px; width: 0; height: 0; border: 10px solid transparent; border-top-color: #dcf8c6; border-left: 0; border-right: 0; margin-top: 0; margin-right: -10px;}

        .msg-meta { font-size: 0.7rem; color: #999; align-self: flex-end; display: flex; align-items: center; gap: 4px; margin-top: 4px; }
        .msg-ticks { font-size: 0.8rem; }
        .msg-ticks.read { color: #34B7F1; } /* Ø§Ù„Ø£Ø²Ø±Ù‚ Ù„Ù„ØµØ­ÙŠÙ† */
        .msg-ticks.sent { color: #999; } /* Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ */

        .chat-input-area { padding: 10px; background: #f0f0f0; display: flex; gap: 10px; }
        .chat-input-area input { flex:1; padding: 12px; border-radius: 25px; border:none; outline:none; }
        
        /* Parent Product List */
        .parent-products-list { margin-top: 15px; background: white; border-radius: 12px; padding: 15px; text-align: right; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .prod-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem; }
        .prod-row:last-child { border-bottom: none; }
        
        /* Mini Products */
        .mini-product-list { margin-bottom: 15px; max-height: 150px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 5px; background: #fafafa; }
        .mini-product-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px 12px; margin-bottom: 5px; border-radius: 6px; border-bottom: 1px solid #f1f1f1; }
        .btn-delete-mini { background: #ff7675; color: white; border: none; width: 25px; height: 25px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <img src="https://raw.githubusercontent.com/mohamednasr5/opera/main/01.png" alt="Logo" style="width:100px; margin-bottom:15px; border-radius: 50%; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
            <h2>Ø§Ø³ØªØ¶Ø§ÙØ© Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ±</h2>
            <p style="color:#666; margin-bottom:20px;">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            <input type="password" id="login-pass" class="login-input" placeholder="****" onkeypress="handleEnter(event)">
            <button class="btn btn-primary" onclick="checkLogin()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <header>
        <div class="header-top">
            <span>ğŸ“… <span id="header-datetime">...</span></span>
            <div id="admin-controls" style="display:flex; gap:10px;">
                <button id="nav-logout-btn" class="logout-btn-styled hidden" onclick="logout()">
                    Ø®Ø±ÙˆØ¬ <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
        <div class="header-content">
            <img src="https://raw.githubusercontent.com/mohamednasr5/opera/main/01.png" alt="Logo" class="logo-img">
            <div class="header-text">
                <h1>ğŸª Ø§Ø³ØªØ¶Ø§ÙØ© Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ±</h1>
                <p id="view-subtitle">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØªØ¨Ø¹ Ø§Ù„Ø£Ø·ÙØ§Ù„</p>
            </div>
        </div>
    </header>

    <main id="app">
        
        <div id="staff-view" class="hidden">
            <div class="dashboard-grid">
                
                <section class="card">
                    <h2 style="margin-bottom: 1.5rem; color: var(--primary);">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø·ÙÙ„ Ø¬Ø¯ÙŠØ¯</h2>
                    <form id="checkin-form">
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„</label>
                            <input type="text" id="child-name" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„" required>
                        </div>
                        <div class="form-group">
                            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                            <input type="tel" id="parent-phone" class="form-control" placeholder="01xxxxxxxxx" maxlength="11" required>
                            <small style="color:#888; font-size:0.8rem;">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 01 ÙˆÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù…</small>
                        </div>
                        
                        <div class="form-group" style="background: #fdfdfd; padding: 10px; border: 1px dashed #ccc; border-radius: 10px;">
                            <label style="color: var(--primary); font-weight: bold;">ğŸ’° Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©</label>
                            <select id="pricing-mode" class="form-control" style="font-weight: bold; color: #333;">
                                <option value="hourly">â±ï¸ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø³Ø§Ø¹Ø© (30Ø¬ - Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ø³Ø§Ø¹ØªÙŠÙ†)</option>
                                <option value="package3">ğŸ“¦ Ø¨Ø§ÙƒØ¯Ø¬ 3 Ø³Ø§Ø¹Ø§Øª (100Ø¬ Ø´Ø§Ù…Ù„ Ø§Ù„ÙˆØ¬Ø¨Ø©)</option>
                                <option value="package5">ğŸŒŸ Ø¨Ø§ÙƒØ¯Ø¬ Ù†ØµÙ ÙŠÙˆÙ… (150Ø¬ Ø­ØªÙ‰ 5 Ø³Ø§Ø¹Ø§Øª)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Ù…Ù†ØªØ¬ Ø¥Ø¶Ø§ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <input type="text" id="extra-item" class="form-control" placeholder="Ù…Ø«Ù„Ø§Ù‹: ÙØ´Ø§Ø±">
                        </div>
                        <div class="form-group">
                            <label>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</label>
                            <input type="number" id="extra-price" class="form-control" placeholder="Ø¬.Ù…">
                        </div>
                        <button type="submit" class="btn btn-primary">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
                    </form>
                    
                    <div id="new-child-qr" class="hidden text-center" style="margin-top: 1.5rem; border-top: 1px dashed #ccc; padding-top: 1rem;">
                        <h3 style="color: var(--success);">âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
                        <div id="qr-code" style="display:flex; justify-content:center; margin: 15px 0;"></div>
                        <div style="display:grid; gap:10px;">
                            <button class="btn btn-whatsapp" id="wa-btn-new">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨</button>
                            <button class="btn btn-outline" onclick="closeQR()">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                </section>

                <section>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="admin-search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯...">
                    </div>
                    <div class="card">
                        <h2 style="margin-bottom:1rem;">ğŸ‘¶ Ø§Ù„Ø£Ø·ÙØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†</h2>
                        <div id="kids-list-active"></div>
                    </div>
                    <div class="card" style="background: #fafafa;">
                        <h2 style="margin-bottom:1rem; color:#7f8c8d;">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…</h2>
                        <div id="kids-list-history"></div>
                    </div>
                </section>
            </div>
        </div>

        <div id="financial-view" class="hidden">
            <h2 style="margin-bottom:2rem; text-align:center;">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„ÙŠ</h2>
            
            <div class="stats-grid">
                <div class="stat-card income-card">
                    <h3>ØµØ§ÙÙŠ Ø§Ù„ÙŠÙˆÙ…</h3>
                    <div class="value" id="stat-day-income">0 Ø¬.Ù…</div>
                </div>
                <div class="stat-card product-card">
                    <h3>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (ÙŠÙˆÙ…ÙŠ)</h3>
                    <div class="value" id="stat-day-products">0 Ø¬.Ù…</div>
                </div>
                <div class="stat-card income-card">
                    <h3>ØµØ§ÙÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h3>
                    <div class="value" id="stat-week-income">0 Ø¬.Ù…</div>
                </div>
                <div class="stat-card income-card">
                    <h3>ØµØ§ÙÙŠ Ø§Ù„Ø´Ù‡Ø±</h3>
                    <div class="value" id="stat-month-income">0 Ø¬.Ù…</div>
                </div>
                <div class="stat-card clickable" onclick="toggleDailyDetails()">
                    <h3>Ø¹Ø¯Ø¯ Ø£Ø·ÙØ§Ù„ Ø§Ù„ÙŠÙˆÙ…</h3>
                    <div class="value" id="stat-day-count">0</div>
                    <div style="font-size:0.8rem; color:var(--primary); margin-top:5px;">Ø§Ø¶ØºØ· Ù„Ù„ØªÙØ§ØµÙŠÙ„</div>
                </div>
            </div>

            <div id="daily-details-container" class="hidden card">
                <h3 style="margin-bottom:1rem; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„ Ø§Ù„Ù…ØºØ§Ø¯Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</h3>
                <div id="financial-kids-list"></div>
            </div>
        </div>

        <div id="parent-view" class="hidden">
            <div class="scene-container"></div>
            <div class="parent-view-card">
                <div id="p-status-badge" style="padding:5px 15px; border-radius:20px; display:inline-block; font-weight:bold; margin-bottom:10px;"></div>
                <h2 id="p-child-name"></h2>
                <div id="p-child-id" style="color:#666; margin-bottom:10px;"></div>
                <div id="p-pricing-mode" style="background:#f0f0f0; padding:5px 10px; border-radius:8px; display:inline-block; font-size:0.9rem; margin-bottom:15px; color:#555;"></div>
                
                <div class="parent-timer-circle" id="parent-timer-container">
                    <div class="timer-text-big" id="live-timer">00:00:00</div>
                </div>
                
                <h3 style="color:var(--primary); margin:20px 0;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="live-cost">0</span> Ø¬.Ù…</h3>
                
                <div id="parent-products-container" class="parent-products-list hidden">
                    <h4 style="margin-bottom:10px; color:#555; border-bottom:1px solid #eee; padding-bottom:5px;">ğŸ›’ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h4>
                    <div id="parent-products-items"></div>
                </div>

                <div class="chat-container">
                    <div id="parent-chat-messages" class="chat-messages"></div>
                    <div class="chat-input-area">
                        <input type="text" id="parent-message-input" placeholder="Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©...">
                        <button class="btn btn-primary" onclick="sendParentMessage()" style="width:auto; border-radius:50%; padding:10px 15px;">â¤</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="admin-chat-modal" class="modal">
        <div class="modal-content" style="height:80vh; display:flex; flex-direction:column; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-color:#e5ddd5;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; background:white; padding:10px; border-radius:10px;">
                <h3 id="chat-modal-title">Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
                <button onclick="closeAdminChat()" style="background:none; border:none; font-size:1.5rem;">&times;</button>
            </div>
            <div id="admin-chat-history" class="chat-messages" style="flex:1;"></div>
            <div class="chat-input-area">
                <input type="text" id="admin-chat-input" placeholder="Ø±Ø¯...">
                <button class="btn btn-primary" onclick="sendAdminMessage()" style="width:auto;">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <div id="checkout-modal" class="modal">
        <div class="modal-content" style="padding: 0; background: transparent; max-width: 380px;">
            <div class="receipt-card">
                <div class="receipt-header">
                    <img src="https://raw.githubusercontent.com/mohamednasr5/opera/main/01.png" style="width:50px; border-radius:50%; border:2px solid white; margin-bottom:5px;">
                    <h3>Ø§Ø³ØªØ¶Ø§ÙØ© Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ±</h3>
                </div>
                <div class="receipt-body">
                    <div class="receipt-row bold">
                        <span>Ø§Ù„Ø·ÙÙ„:</span>
                        <span id="receipt-child-name">--</span>
                    </div>
                    <div class="receipt-row">
                        <span>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø©:</span>
                        <span id="receipt-mode-text" style="font-size:0.85rem;">--</span>
                    </div>
                    <div class="receipt-row">
                        <span>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ:</span>
                        <span id="receipt-hours-text" dir="ltr">--</span>
                    </div>
                    <div class="dashed-divider"></div>
                    <div class="receipt-row bold" style="color:var(--primary);">
                        <span>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ¶Ø§ÙØ©:</span>
                        <span id="receipt-entry-cost">0 Ø¬.Ù…</span>
                    </div>
                    
                    <div class="dashed-divider"></div>
                    <div style="font-weight:bold; margin-bottom:10px;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©:</div>
                    <div id="receipt-products-list"></div>
                    <div class="dashed-divider"></div>
                    <div class="receipt-total-box">
                        <div style="font-size:0.9rem; color:#777;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</div>
                        <div class="receipt-total" id="receipt-grand-total">0 Ø¬.Ù…</div>
                    </div>
                    <div style="display:grid; gap:10px; margin-top:20px;">
                        <a id="receipt-whatsapp-btn" href="#" target="_blank" class="btn btn-whatsapp">
                            <i class="fab fa-whatsapp"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ§ØªØ³Ø§Ø¨
                        </a>
                        <div style="display:flex; gap:10px;" id="checkout-actions">
                            <button class="btn btn-danger" onclick="confirmCheckout()" id="btn-confirm-out">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                            <button class="btn btn-outline" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                    <div class="receipt-footer">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ… .. Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… ÙŠÙˆÙ…Ø§Ù‹ Ø³Ø¹ÙŠØ¯Ø§Ù‹!</div>
                </div>
            </div>
        </div>
    </div>

    <div id="add-product-modal" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--accent); margin-bottom: 1rem; text-align:center;">ğŸ›ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
            <div id="current-products-list" class="mini-product-list"></div>
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                <input type="text" id="new-product-name" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø¹ØµÙŠØ±">
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ø³Ø¹Ø±</label>
                <input type="number" id="new-product-price" class="form-control" placeholder="0">
            </div>
            <div style="display:flex; gap:10px; justify-content:center; margin-top: 15px;">
                <button class="btn btn-info" onclick="submitAddProduct()">Ø¥Ø¶Ø§ÙØ© ÙˆØ¥ØºÙ„Ø§Ù‚</button>
                <button class="btn btn-outline" onclick="closeProductModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <audio id="msg-sound" src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_3f32527b79.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, set, get, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDIH-wzZV71U-zbkxArRE4f9oiCtwvKOWA",
            authDomain: "operaestdafa.firebaseapp.com",
            databaseURL: "https://operaestdafa-default-rtdb.firebaseio.com",
            projectId: "operaestdafa",
            storageBucket: "operaestdafa.firebasestorage.app",
            messagingSenderId: "44885598287",
            appId: "1:44885598287:web:e2b0d3497b86c69de38a3a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- GLOBAL VARIABLES ---
        let currentChildId = null; 
        let childIdForProduct = null;
        let searchQuery = "";
        let currentChatId = null;

        // --- DOM ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const staffView = document.getElementById('staff-view');
        const financialView = document.getElementById('financial-view');
        
        // --- AUTH & ROUTING ---
        window.handleEnter = (e) => { if(e.key === 'Enter') checkLogin(); }
        
        window.checkLogin = () => {
            const p = document.getElementById('login-pass').value;
            if(p === '0100') {
                loginScreen.classList.add('hidden');
                staffView.classList.remove('hidden');
                financialView.classList.add('hidden');
                document.getElementById('nav-logout-btn').classList.remove('hidden');
                document.getElementById('view-subtitle').innerText = "Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠ";
                initStaffView();
            } 
            else if (p === '521988') {
                loginScreen.classList.add('hidden');
                staffView.classList.add('hidden');
                financialView.classList.remove('hidden');
                document.getElementById('nav-logout-btn').classList.remove('hidden');
                document.getElementById('view-subtitle').innerText = "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©";
                initFinancialView();
            } 
            else { 
                alert("Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"); 
            }
        };
        
        window.logout = () => location.reload();

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('mode') === 'parent' && urlParams.get('id')) {
            loginScreen.classList.add('hidden');
            initParentView(urlParams.get('id'));
        }

        setInterval(() => {
            document.getElementById('header-datetime').innerText = new Date().toLocaleDateString('ar-EG', { weekday:'long', hour:'2-digit', minute:'2-digit' });
        }, 1000);

        // --- Pricing Helper ---
        function getModeLabel(mode) {
            if(mode === 'package3') return 'Ø¨Ø§ÙƒØ¯Ø¬ 3 Ø³Ø§Ø¹Ø§Øª';
            if(mode === 'package5') return 'Ø¨Ø§ÙƒØ¯Ø¬ Ù†ØµÙ ÙŠÙˆÙ…';
            return 'Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø³Ø§Ø¹Ø©';
        }

        // --- Staff View ---
        function initStaffView() {
            onValue(ref(db, 'children'), (snapshot) => {
                const data = snapshot.val();
                const listActive = document.getElementById('kids-list-active');
                const listHistory = document.getElementById('kids-list-history');
                listActive.innerHTML = ''; listHistory.innerHTML = '';
                
                if(!data) return;

                Object.keys(data).forEach(key => {
                    const child = data[key];
                    const modeLabel = getModeLabel(child.pricingMode || 'hourly');
                    
                    let productHTML = '';
                    let productsTotal = 0;
                    if(child.products) {
                        productHTML = '<div style="font-size:0.8rem; color:#666; margin-top:5px;">ğŸ›’ ';
                        Object.values(child.products).forEach(p => {
                            productHTML += `${p.name}, `;
                            productsTotal += parseFloat(p.price);
                        });
                        productHTML += `(Ù…Ø¬Ù…ÙˆØ¹: ${productsTotal} Ø¬.Ù…)</div>`;
                    }

                    const searchText = `${child.name} ${child.phone} ${child.childId}`.toLowerCase();

                    if (child.status === 'in' || child.status === 'paused') {
                        const isPaused = child.status === 'paused';
                        let duration = isPaused 
                            ? (child.pauseStartTime - child.entryTime - (child.totalPausedTime||0))
                            : (Date.now() - child.entryTime - (child.totalPausedTime||0));
                        
                        // Badge logic
                        const msgs = child.messages ? Object.values(child.messages) : [];
                        const unread = msgs.filter(m => m.sender === 'parent' && m.status !== 'read').length;
                        const badge = unread > 0 ? `<span style="background:red; color:white; border-radius:50%; padding:2px 6px; font-size:0.7rem; position:absolute; top:-5px; right:-5px;">${unread}</span>` : '';

                        // WhatsApp Message Logic
                        const trackingUrl = `${window.location.origin}${window.location.pathname}?mode=parent&id=${key}`;
                        const msgBody = `Ù†Ø­Ù† ÙÙŠ ÙƒØ§ÙÙŠÙ‡ ÙˆÙ…Ø·Ø¹Ù… Ø£ÙˆØ¨Ø±Ø§ ÙƒØ§ÙÙŠÙ‡ Ø³Ø¹Ø¯Ø§Ø¡ Ù„Ø­Ø¶ÙˆØ± Ø·ÙÙ„Ùƒ Ù…Ø¹Ù†Ø§ ÙˆÙ†Ø¤ÙƒØ¯ Ø£Ù† Ø·ÙÙ„Ùƒ ÙÙ‰ Ø£Ù…Ø§Ù† Ù…Ø¹Ù†Ø§ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹ØªÙ‡ Ù…Ù† Ø®Ù„Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙ‰ Ø§Ù‰ ÙˆÙ‚Øª \n ${trackingUrl}`;
                        const waUrl = `https://wa.me/2${child.phone}?text=${encodeURIComponent(msgBody)}`;

                        const div = document.createElement('div');
                        div.className = `kid-card ${isPaused ? 'paused-status' : 'in-status'}`;
                        div.setAttribute('data-search', searchText);
                        
                        div.innerHTML = `
                            <div class="kid-info">
                                <h3>${child.name} <span style="background:#eee; padding:2px 8px; border-radius:5px; font-size:0.8rem;">#${child.childId}</span></h3>
                                <div style="font-size:0.85rem; color:#888; margin-bottom:5px;">
                                    <span class="pricing-badge">${modeLabel}</span> ğŸ“± ${child.phone}
                                </div>
                                ${productHTML}
                                <div class="timer-display" style="${isPaused?'color:orange;':''}">
                                    â³ ${isPaused ? 'Ù…Ø¤Ù‚Øª' : 'Ø¬Ø§Ø±ÙŠ'}: <span class="live-timer" data-start="${child.entryTime}" data-paused="${child.totalPausedTime||0}" data-status="${child.status}">${formatDuration(duration)}</span>
                                </div>
                            </div>
                            
                            <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px;">
                                <button class="btn btn-danger" style="padding: 8px 20px;" onclick="prepareCheckout('${key}')">Ø®Ø±ÙˆØ¬</button>
                                <button class="btn btn-primary" style="width:45px;" onclick="openAdminChat('${key}', '${child.name}')"><i class="fas fa-comments"></i> ${badge}</button>
                                ${isPaused 
                                    ? `<button class="btn btn-success" style="width:45px;" onclick="resumeChild('${key}')"><i class="fas fa-play"></i></button>`
                                    : `<button class="btn btn-warning" style="width:45px;" onclick="pauseChild('${key}')"><i class="fas fa-pause"></i></button>`
                                }
                                <a href="${waUrl}" target="_blank" class="btn btn-whatsapp" style="width:45px; text-decoration:none; display:inline-flex;"><i class="fab fa-whatsapp"></i></a>
                                <button class="btn btn-purple" style="width:45px;" onclick="openProductModal('${key}')" title="Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª"><i class="fas fa-shopping-cart"></i></button>
                            </div>
                        `;
                        listActive.appendChild(div);
                    } else {
                        const div = document.createElement('div');
                        div.className = 'kid-card out-status';
                        div.setAttribute('data-search', searchText);
                        div.innerHTML = `
                            <div class="kid-info">
                                <h3 style="color:#777; text-decoration:line-through;">${child.name}</h3>
                                <div>ğŸ’° ${child.totalCost} Ø¬.Ù… | ğŸ“… ${new Date(child.exitTime).toLocaleTimeString('ar-EG')}</div>
                                <div style="font-size:0.8rem; color:#999;">${modeLabel}</div>
                            </div>
                        `;
                        listHistory.appendChild(div);
                    }
                });
                filterList();
            });

            setInterval(() => {
                document.querySelectorAll('.live-timer').forEach(el => {
                    if(el.dataset.status === 'in') {
                        const t = Date.now() - parseInt(el.dataset.start) - parseInt(el.dataset.paused);
                        el.innerText = formatDuration(t);
                    }
                });
            }, 1000);
        }

        document.getElementById('checkin-form').onsubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById('child-name').value;
            const phone = document.getElementById('parent-phone').value;
            const mode = document.getElementById('pricing-mode').value; // Get Pricing Mode
            const item = document.getElementById('extra-item').value;
            const price = document.getElementById('extra-price').value;

            const phoneRegex = /^01\d{9}$/;
            if (!phoneRegex.test(phone)) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ­ÙŠØ­ (11 Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 01)");

            const newRef = push(ref(db, 'children'));
            const code = Math.floor(1000 + Math.random() * 9000);
            
            const data = {
                name, phone, childId: code,
                pricingMode: mode, // Save Pricing Mode
                entryTime: Date.now(), status: 'in', totalPausedTime: 0
            };
            set(newRef, data).then(() => {
                if(item && price) {
                    push(ref(db, `children/${newRef.key}/products`), { name: item, price: parseFloat(price) });
                }
                document.getElementById('checkin-form').reset();
                document.getElementById('pricing-mode').value = 'hourly'; // Reset to default
                const link = `${window.location.origin}${window.location.pathname}?mode=parent&id=${newRef.key}`;
                
                const qrDiv = document.getElementById('new-child-qr');
                qrDiv.classList.remove('hidden');
                document.getElementById('qr-code').innerHTML = '';
                new QRCode(document.getElementById('qr-code'), { text: link, width:100, height:100 });
                
                const msgBody = `Ù†Ø­Ù† ÙÙŠ ÙƒØ§ÙÙŠÙ‡ ÙˆÙ…Ø·Ø¹Ù… Ø£ÙˆØ¨Ø±Ø§ ÙƒØ§ÙÙŠÙ‡ Ø³Ø¹Ø¯Ø§Ø¡ Ù„Ø­Ø¶ÙˆØ± Ø·ÙÙ„Ùƒ Ù…Ø¹Ù†Ø§ ÙˆÙ†Ø¤ÙƒØ¯ Ø£Ù† Ø·ÙÙ„Ùƒ ÙÙ‰ Ø£Ù…Ø§Ù† Ù…Ø¹Ù†Ø§ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹ØªÙ‡ Ù…Ù† Ø®Ù„Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙ‰ Ø§Ù‰ ÙˆÙ‚Øª \n ${link}`;
                const whatsappPhone = '2' + phone;
                
                document.getElementById('wa-btn-new').onclick = () => window.open(`https://wa.me/${whatsappPhone}?text=${encodeURIComponent(msgBody)}`, '_blank');
            });
        };
        window.closeQR = () => document.getElementById('new-child-qr').classList.add('hidden');

        document.getElementById('admin-search').addEventListener('keyup', (e) => {
            searchQuery = e.target.value.toLowerCase();
            filterList();
        });

        function filterList() {
            const cards = document.querySelectorAll('.kid-card');
            cards.forEach(card => {
                const txt = card.getAttribute('data-search') || "";
                if (txt.includes(searchQuery)) card.style.display = 'flex';
                else card.style.display = 'none';
            });
        }

        window.pauseChild = (id) => update(ref(db, `children/${id}`), { status:'paused', pauseStartTime: Date.now() });
        window.resumeChild = (id) => {
            get(ref(db, `children/${id}`)).then(s => {
                const d = s.val();
                const p = Date.now() - d.pauseStartTime;
                update(ref(db, `children/${id}`), { status:'in', totalPausedTime: (d.totalPausedTime||0) + p });
            });
        };

        // --- Financial View ---
        function initFinancialView() {
            onValue(ref(db, 'children'), (snapshot) => {
                const data = snapshot.val();
                if(!data) return;

                let dayInc = 0, weekInc = 0, monthInc = 0, dayCount = 0;
                let dayProductSales = 0; 
                
                const now = new Date();
                const todayStr = now.toDateString();
                const currentMonth = now.getMonth();
                const d = new Date();
                const dayNum = d.getDay(); 
                const daysToSaturday = (dayNum + 1) % 7; 
                const startOfWeekTs = new Date(d.setDate(d.getDate() - daysToSaturday)).setHours(0,0,0,0);

                Object.keys(data).forEach(key => {
                    const child = data[key];
                    if (child.status === 'out' && child.exitTime) {
                        const cost = parseFloat(child.totalCost || 0);
                        const exitDate = new Date(child.exitTime);

                        if (exitDate.toDateString() === todayStr) {
                            dayInc += cost;
                            dayCount++;
                            if(child.products) Object.values(child.products).forEach(p => dayProductSales += parseFloat(p.price));
                        }
                        
                        if (exitDate.getMonth() === currentMonth && exitDate.getFullYear() === now.getFullYear()) {
                            monthInc += cost;
                        }

                        if (child.exitTime >= startOfWeekTs) {
                            weekInc += cost;
                        }
                    }
                });

                document.getElementById('stat-day-income').innerText = dayInc + ' Ø¬.Ù…';
                document.getElementById('stat-week-income').innerText = weekInc + ' Ø¬.Ù…';
                document.getElementById('stat-month-income').innerText = monthInc + ' Ø¬.Ù…';
                document.getElementById('stat-day-count').innerText = dayCount;
                document.getElementById('stat-day-products').innerText = dayProductSales + ' Ø¬.Ù…';
                renderDailyDetails(data, todayStr);
            });
        }

        window.toggleDailyDetails = () => {
            document.getElementById('daily-details-container').classList.toggle('hidden');
        };

        function renderDailyDetails(data, todayStr) {
            const listDiv = document.getElementById('financial-kids-list');
            listDiv.innerHTML = '';
            
            let found = false;
            Object.keys(data).forEach(key => {
                const child = data[key];
                if(child.status === 'out' && child.exitTime) {
                    const exitDate = new Date(child.exitTime);
                    if (exitDate.toDateString() === todayStr) {
                        found = true;
                        const item = document.createElement('div');
                        item.style.cssText = "padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; cursor:pointer;";
                        item.innerHTML = `
                            <div>
                                <div style="font-weight:bold;">${child.name}</div>
                                <div style="font-size:0.85rem; color:#888;">${getModeLabel(child.pricingMode)}</div>
                            </div>
                            <div style="font-weight:bold; color:var(--success);">${child.totalCost} Ø¬.Ù…</div>
                        `;
                        item.onclick = () => showReceiptModal(child, key, true);
                        listDiv.appendChild(item);
                    }
                }
            });
            if(!found) listDiv.innerHTML = '<div style="text-align:center; padding:10px; color:#999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®Ø±ÙˆØ¬ Ø§Ù„ÙŠÙˆÙ…</div>';
        }

        // --- Product Management ---
        window.openProductModal = (id) => {
            childIdForProduct = id;
            const listContainer = document.getElementById('current-products-list');
            listContainer.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
            get(ref(db, `children/${id}/products`)).then(snap => {
                listContainer.innerHTML = '';
                if(snap.exists()) {
                    snap.forEach(pSnap => {
                        const p = pSnap.val();
                        listContainer.innerHTML += `
                            <div class="mini-product-item">
                                <span>${p.name} (${p.price} Ø¬.Ù…)</span>
                                <button class="btn-delete-mini" onclick="deleteProduct('${id}', '${pSnap.key}')"><i class="fas fa-trash"></i></button>
                            </div>`;
                    });
                } else {
                    listContainer.innerHTML = '<div style="text-align:center; color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</div>';
                }
            });
            document.getElementById('new-product-name').value = '';
            document.getElementById('new-product-price').value = '';
            document.getElementById('add-product-modal').style.display = 'flex';
        };

        window.deleteProduct = (childId, prodKey) => {
            if(confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) remove(ref(db, `children/${childId}/products/${prodKey}`)).then(() => openProductModal(childId));
        };
        window.closeProductModal = () => document.getElementById('add-product-modal').style.display = 'none';
        window.submitAddProduct = () => {
            const name = document.getElementById('new-product-name').value;
            const price = document.getElementById('new-product-price').value;
            if(!name || !price) return;
            push(ref(db, `children/${childIdForProduct}/products`), { name, price: parseFloat(price) }).then(() => closeProductModal());
        };

        // --- Checkout Logic (UPDATED) ---
        function calculateEntryCost(c, msDuration) {
            const hours = Math.ceil(msDuration / 3600000); // Ceiling: any part of hour is hour
            const mode = c.pricingMode || 'hourly';

            if (mode === 'package3') {
                return 100;
            } else if (mode === 'package5') {
                return 150;
            } else {
                // Hourly Mode
                // Minimum 2 hours
                const chargeableHours = Math.max(hours, 2); 
                return chargeableHours * 30; // 30 EGP per hour
            }
        }

        function showReceiptModal(c, key, isReadOnly = false) {
            let ms = c.status === 'paused' 
                ? c.pauseStartTime - c.entryTime - (c.totalPausedTime||0)
                : (c.status === 'out' && c.exitTime) ? (c.exitTime - c.entryTime - (c.totalPausedTime||0)) 
                : Date.now() - c.entryTime - (c.totalPausedTime||0);
            
            const hoursCeil = Math.ceil(ms / 3600000); 
            const entryCost = calculateEntryCost(c, ms);

            let productsCost = 0;
            let productsListHTML = '';
            let productsTextForWA = '';

            if(c.products) {
                Object.values(c.products).forEach(p => {
                    productsCost += parseFloat(p.price);
                    productsListHTML += `<div class="receipt-row"><span>${p.name}</span><span>${p.price} Ø¬.Ù…</span></div>`;
                    productsTextForWA += `\nğŸ›ï¸ ${p.name}: ${p.price} Ø¬.Ù…`;
                });
            } else {
                productsListHTML = '<div style="color:#999; text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>';
                productsTextForWA = '\nğŸ›ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©';
            }

            const grandTotal = entryCost + productsCost;

            document.getElementById('receipt-child-name').innerText = c.name;
            document.getElementById('receipt-mode-text').innerText = getModeLabel(c.pricingMode);
            document.getElementById('receipt-hours-text').innerText = `${hoursCeil} Ø³Ø§Ø¹Ø© / ${formatDuration(ms)}`;
            document.getElementById('receipt-entry-cost').innerText = `${entryCost} Ø¬.Ù…`;
            document.getElementById('receipt-products-list').innerHTML = productsListHTML;
            document.getElementById('receipt-grand-total').innerText = `${grandTotal} Ø¬.Ù…`;

            const waPhone = '2' + c.phone;
            const waText = `ğŸ§¾ *ÙØ§ØªÙˆØ±Ø© Ø§Ø³ØªØ¶Ø§ÙØ© Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ±*\n------------------------\nğŸ‘¤ *Ø§Ù„Ø·ÙÙ„:* ${c.name}\nğŸ”– *Ø§Ù„Ù†Ø¸Ø§Ù…:* ${getModeLabel(c.pricingMode)}\nâ³ *Ø§Ù„ÙˆÙ‚Øª:* ${hoursCeil} Ø³Ø§Ø¹Ø©\nğŸ’° *Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø³ØªØ¶Ø§ÙØ©:* ${entryCost} Ø¬.Ù…${productsTextForWA}\n------------------------\nğŸ’µ *Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:* *${grandTotal} Ø¬.Ù…*\nğŸ“… ${new Date().toLocaleDateString('ar-EG')}\n------------------------\nØ´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ…! â¤ï¸`;
            document.getElementById('receipt-whatsapp-btn').href = `https://wa.me/${waPhone}?text=${encodeURIComponent(waText)}`;

            const confirmBtn = document.getElementById('btn-confirm-out');
            if(isReadOnly) {
                confirmBtn.style.display = 'none';
            } else {
                confirmBtn.style.display = 'inline-block';
                document.getElementById('checkout-modal').dataset.total = grandTotal;
            }
            document.getElementById('checkout-modal').style.display = 'flex';
        }

        window.prepareCheckout = (id) => {
            currentChildId = id;
            get(ref(db, `children/${id}`)).then(s => showReceiptModal(s.val(), id, false));
        };
        window.confirmCheckout = () => {
            const total = document.getElementById('checkout-modal').dataset.total;
            update(ref(db, `children/${currentChildId}`), { status: 'out', exitTime: Date.now(), totalCost: total }).then(() => closeModal());
        };
        window.closeModal = () => document.getElementById('checkout-modal').style.display = 'none';

        // --- PARENT VIEW & CHAT ---
        function initParentView(childId) {
            currentChatId = childId;
            document.getElementById('parent-view').classList.remove('hidden');
            
            // Read status update
            get(ref(db, `children/${childId}/messages`)).then(s => {
                if(s.exists()) s.forEach(c => { if(c.val().sender==='admin' && c.val().status!=='read') update(ref(db, `children/${childId}/messages/${c.key}`), {status:'read'}); });
            });

            onValue(ref(db, `children/${childId}`), (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                document.getElementById('p-child-name').innerText = data.name;
                document.getElementById('p-child-id').innerText = `ID: ${data.childId}`;
                document.getElementById('p-pricing-mode').innerText = "Ù†Ø¸Ø§Ù…: " + getModeLabel(data.pricingMode);

                const costEl = document.getElementById('live-cost');
                const containerEl = document.getElementById('parent-timer-container');

                // Products
                const prodContainer = document.getElementById('parent-products-container');
                const prodItems = document.getElementById('parent-products-items');
                let prodCost = 0;
                
                if (data.products) {
                    prodContainer.classList.remove('hidden');
                    prodItems.innerHTML = '';
                    Object.values(data.products).forEach(p => {
                        prodCost += parseFloat(p.price);
                        prodItems.innerHTML += `<div class="prod-row"><span>${p.name}</span><span>${p.price} Ø¬.Ù…</span></div>`;
                    });
                } else {
                    prodContainer.classList.add('hidden');
                }

                if (data.status === 'in') {
                    containerEl.innerHTML = '<div class="timer-text-big" id="live-timer">00:00:00</div>';
                    const updateTimer = () => {
                        const ms = Date.now() - data.entryTime - (data.totalPausedTime || 0);
                        document.getElementById('live-timer').innerText = formatDuration(ms);
                        
                        // Live Cost Calculation for Parent
                        const entryCost = calculateEntryCost(data, ms);
                        costEl.innerText = entryCost + prodCost;
                    };
                    updateTimer();
                    if(!window.parentTimerInterval) window.parentTimerInterval = setInterval(updateTimer, 1000);
                } else if (data.status === 'paused') {
                    if(window.parentTimerInterval) clearInterval(window.parentTimerInterval);
                    containerEl.innerHTML = '<div class="paused-text-msg">ØªÙ… Ø§ÙŠÙ‚Ø§Ù Ø§Ù„ÙˆÙ‚Øª<br>Ù„Ø­ÙŠÙ† Ø¹ÙˆØ¯Ø© Ø§Ù„Ø·ÙÙ„ âœ‹</div>';
                    
                    const ms = data.pauseStartTime - data.entryTime - (data.totalPausedTime || 0);
                    const entryCost = calculateEntryCost(data, ms);
                    costEl.innerText = entryCost + prodCost;

                } else if (data.status === 'out') {
                    if(window.parentTimerInterval) clearInterval(window.parentTimerInterval);
                    containerEl.innerHTML = '<div class="paused-text-msg" style="color:gray">ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬ ğŸ‘‹</div>';
                    costEl.innerText = data.totalCost;
                }

                // Chat Render
                const chatDiv = document.getElementById('parent-chat-messages');
                chatDiv.innerHTML = '';
                if(data.messages) {
                    Object.values(data.messages).forEach(m => {
                        let tickIcon = '';
                        if(m.sender === 'parent') {
                            if(m.status === 'read') tickIcon = '<span class="msg-ticks read">âœ“âœ“</span>';
                            else tickIcon = '<span class="msg-ticks sent">âœ“</span>';
                        }
                        const time = new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        chatDiv.innerHTML += `
                            <div class="message ${m.sender === 'parent' ? 'sent' : 'received'}">
                                ${m.text}
                                <span class="msg-meta">${time} ${tickIcon}</span>
                            </div>`;
                    });
                    chatDiv.scrollTop = chatDiv.scrollHeight;
                }
            });

            window.sendParentMessage = () => {
                const txt = document.getElementById('parent-message-input').value;
                if(!txt) return;
                push(ref(db, `children/${childId}/messages`), { sender: 'parent', text: txt, timestamp: Date.now(), status: 'new' });
                document.getElementById('parent-message-input').value = '';
            };
        }

        // --- Admin Chat Logic ---
        window.openAdminChat = (id, name) => {
            currentChatId = id;
            document.getElementById('chat-modal-title').innerText = name;
            document.getElementById('admin-chat-modal').style.display = 'flex';
            
            get(ref(db, `children/${id}/messages`)).then(s => {
                if(s.exists()) s.forEach(c => { if(c.val().sender==='parent' && c.val().status!=='read') update(ref(db, `children/${id}/messages/${c.key}`), {status:'read'}); });
            });

            onValue(ref(db, `children/${id}/messages`), s => {
                const div = document.getElementById('admin-chat-history');
                div.innerHTML = '';
                if(s.exists()) {
                    Object.values(s.val()).forEach(m => {
                        let tickIcon = '';
                        if(m.sender === 'admin') {
                            if(m.status === 'read') tickIcon = '<span class="msg-ticks read">âœ“âœ“</span>';
                            else tickIcon = '<span class="msg-ticks sent">âœ“</span>';
                        }
                        const time = new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        div.innerHTML += `
                            <div class="message ${m.sender === 'admin' ? 'sent' : 'received'}">
                                ${m.text}
                                <span class="msg-meta">${time} ${tickIcon}</span>
                            </div>`;
                    });
                    div.scrollTop = div.scrollHeight;
                }
            });
        };
        window.closeAdminChat = () => document.getElementById('admin-chat-modal').style.display = 'none';
        window.sendAdminMessage = () => {
            const txt = document.getElementById('admin-chat-input').value;
            if(!txt) return;
            push(ref(db, `children/${currentChatId}/messages`), { sender: 'admin', text: txt, timestamp: Date.now(), status: 'new' });
            document.getElementById('admin-chat-input').value = '';
        };

        function formatDuration(ms) {
            if(ms < 0) ms = 0;
            const s = Math.floor((ms/1000)%60).toString().padStart(2,'0');
            const m = Math.floor((ms/60000)%60).toString().padStart(2,'0');
            const h = Math.floor(ms/3600000).toString().padStart(2,'0');
            return `${h}:${m}:${s}`;
        }
    </script>
</body>
</html>
