<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ± - Kids Area System</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† --- */
        :root {
            --primary: #ff4757;
            --primary-hover: #ff6b81;
            --secondary: #2f3542;
            --accent: #1e90ff;
            --success: #2ed573;
            --warning: #ffa502;
            --bg-body: #f1f2f6;
            --surface: #ffffff;
            --radius: 16px;
            --shadow: 0 8px 24px rgba(149, 157, 165, 0.1);
        }

        /* --- Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--secondary); min-height: 100vh; overflow-x: hidden; position: relative; }
        
        /* --- Ø®Ù„ÙÙŠØ© Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© (Ù…Ù† Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£ÙˆÙ„) --- */
        .scene-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; background: linear-gradient(to bottom, #87CEEB 0%, #E0F7FA 100%); }
        .cloud { position: absolute; background: #fff; border-radius: 100px; opacity: 0.8; animation: floatCloud 40s linear infinite; }
        .cloud::after, .cloud::before { content: ''; position: absolute; background: #fff; border-radius: 50%; }
        .cloud-1 { width: 120px; height: 50px; top: 10%; left: -150px; } .cloud-1::after { width: 50px; height: 50px; top: -25px; left: 20px; } .cloud-1::before { width: 60px; height: 60px; top: -35px; left: 45px; }
        .cloud-2 { width: 100px; height: 40px; top: 30%; left: -120px; animation-delay: -20s; opacity: 0.6; } .cloud-2::after { width: 40px; height: 40px; top: -20px; left: 15px; }
        .ground-hill { position: absolute; bottom: -60px; left: 0; width: 100%; height: 120px; background: #55efc4; border-radius: 50% 50% 0 0 / 100% 100% 0 0; z-index: -1; }
        @keyframes floatCloud { 0% { left: -150px; } 100% { left: 110%; } }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); position: sticky; top: 0; z-index: 100; padding: 10px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .logo-section { display: flex; align-items: center; gap: 10px; }
        .logo-img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #eee; }
        
        /* --- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø¹Ù†Ø§ØµØ± --- */
        main { padding: 20px; max-width: 1200px; margin: 0 auto; padding-bottom: 80px; }
        .card { background: var(--surface); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; animation: slideUp 0.4s ease; }
        
        .form-control { width: 100%; padding: 12px; background: #f8f9fa; border: 1px solid #dfe4ea; border-radius: 12px; margin-bottom: 10px; transition: 0.3s; }
        .form-control:focus { border-color: var(--accent); background: white; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-info { background: var(--accent); color: white; }
        .btn-whatsapp { background: #25D366; color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--secondary); color: var(--secondary); }

        /* --- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·ÙÙ„ (Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©) --- */
        .kid-card { 
            background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px; 
            border: 1px solid #f1f2f6; position: relative; overflow: hidden; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: flex; flex-direction: column; gap: 10px;
            transition: 0.3s;
        }
        .kid-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù„ÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */
        .kid-card::before { content: ''; position: absolute; top: 0; right: 0; width: 6px; height: 100%; }
        .status-in::before { background: var(--success); }
        .status-paused::before { background: var(--warning); }
        .status-out::before { background: #bdc3c7; }

        .kid-header { display: flex; justify-content: space-between; align-items: center; }
        .kid-timer { font-family: monospace; font-size: 1.2rem; font-weight: 800; color: var(--primary); background: #fff0f1; padding: 4px 10px; border-radius: 8px; }
        .paused-badge { background: var(--warning); color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-right: 5px; }

        .controls-row { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
        .controls-row .btn { padding: 8px 12px; font-size: 0.85rem; flex: 1; }

        /* --- Ù…ÙˆØ¯Ø§Ù„ ÙˆØªÙ‚Ø§Ø±ÙŠØ± --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 95%; max-width: 500px; animation: popIn 0.3s; max-height: 90vh; overflow-y: auto; }
        
        /* Chat Improvements */
        .chat-box { height: 250px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 10px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; max-width: 80%; }
        .msg.admin { align-self: flex-end; background: #e3f2fd; color: #2c3e50; border-bottom-left-radius: 2px; }
        .msg.parent { align-self: flex-start; background: white; border: 1px solid #eee; border-bottom-right-radius: 2px; }
        
        /* Quick Replies Chips */
        .quick-replies { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 5px; }
        .chip { background: white; border: 1px solid #dfe4ea; padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; white-space: nowrap; }
        .chip:hover { background: var(--accent); color: white; border-color: var(--accent); }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-box { background: #f1f2f6; padding: 15px; border-radius: 12px; text-align: center; }
        .stat-val { font-weight: bold; color: var(--success); font-size: 1.1rem; }

        /* Animations */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .hidden { display: none !important; }

        /* Parent View Specifics */
        .big-timer-circle { width: 220px; height: 220px; background: white; border-radius: 50%; margin: 20px auto; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 8px solid #f1f2f6; }
        .cost-live { font-size: 2.5rem; font-weight: 900; color: var(--secondary); }
    </style>
</head>
<body>

    <div class="scene-container">
        <div class="cloud cloud-1"></div>
        <div class="cloud cloud-2"></div>
        <div class="ground-hill"></div>
    </div>

    <div id="login-screen" style="position:fixed; inset:0; z-index:9999; background:linear-gradient(135deg, #ff9ff3, #feca57); display:flex; justify-content:center; align-items:center;">
        <div class="card" style="text-align:center; width:90%; max-width:400px;">
            <img src="https://raw.githubusercontent.com/mohamednasr5/opera/main/01.png" style="width:100px; margin-bottom:15px; border-radius:50%; box-shadow:0 5px 15px rgba(0,0,0,0.1);">
            <h2 style="margin-bottom:10px;">Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ± ÙƒÙŠØ¯Ø²</h2>
            <input type="password" id="login-pass" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="text-align:center; font-size:1.2rem; letter-spacing:5px;">
            <button class="btn btn-primary" onclick="checkLogin()" style="width:100%;">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <header>
        <div class="logo-section">
            <img src="https://raw.githubusercontent.com/mohamednasr5/opera/main/01.png" class="logo-img">
            <div>
                <h3 style="margin:0; font-size:1rem; color:var(--primary);">Ø£ÙˆØ¨Ø±Ø§ Ø¹Ø§Ø´ÙˆØ±</h3>
                <span id="live-clock" style="font-size:0.75rem; color:#777;">00:00</span>
            </div>
        </div>
        <div id="admin-controls" class="hidden" style="display:flex; gap:10px;">
            <button class="btn btn-info" onclick="openReports()"><i class="fas fa-chart-pie"></i> ØªÙ‚Ø§Ø±ÙŠØ±</button>
            <button class="btn btn-danger" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <main id="app">
        <div id="admin-view" class="hidden">
            
            <section class="card">
                <h3 style="margin-bottom:15px; display:flex; align-items:center; gap:10px;"><i class="fas fa-user-plus" style="color:var(--primary);"></i> Ø¯Ø®ÙˆÙ„ Ø·ÙÙ„ Ø¬Ø¯ÙŠØ¯</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="text" id="child-name" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„">
                    <input type="tel" id="child-phone" class="form-control" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§Ù„Ø¯">
                </div>
                <button class="btn btn-primary" onclick="checkIn()" style="width:100%; margin-top:10px;">Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</button>

                <div id="qr-area" class="hidden" style="text-align:center; margin-top:20px; border-top:1px dashed #eee; padding-top:15px;">
                    <div id="qrcode" style="display:flex; justify-content:center; margin-bottom:15px;"></div>
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <button class="btn btn-whatsapp" id="wa-share-btn"><i class="fab fa-whatsapp"></i> Ø¥Ø±Ø³Ø§Ù„</button>
                        <button class="btn btn-outline" onclick="copyLink()">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
                    </div>
                </div>
            </section>

            <div class="card" style="padding:15px;">
                <input type="text" id="search-box" class="form-control" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø·ÙÙ„..." oninput="renderKids()">
            </div>

            <h4 style="margin:20px 0 10px; color:#555;">Ø§Ù„Ø£Ø·ÙØ§Ù„ Ø§Ù„Ù†Ø´Ø·ÙˆÙ†</h4>
            <div id="active-list"></div>

            <h4 style="margin:30px 0 10px; color:#555;">ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ø¤Ø®Ø±Ø§Ù‹</h4>
            <div id="history-list"></div>
        </div>

        <div id="parent-view" class="hidden">
            <div style="text-align:center; margin-top:20px;">
                <span id="p-status-badge" style="background:var(--success); color:white; padding:5px 15px; border-radius:20px;">Ù…ØªÙˆØ§Ø¬Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹</span>
                <h1 id="p-child-name" style="color:var(--secondary); margin-top:10px;">...</h1>
                
                <div class="big-timer-circle">
                    <div id="p-cost" class="cost-live">0</div>
                    <div style="color:#777;">Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ</div>
                    <div id="p-timer" style="margin-top:10px; font-family:monospace; font-weight:bold; color:var(--primary);">00:00:00</div>
                </div>
                
                <div class="card">
                    <h3 style="margin-bottom:15px;">ğŸ›’ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
                    <div id="p-orders-list" style="text-align:right; color:#555;"></div>
                </div>

                <div class="card">
                    <h3>ğŸ’¬ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
                    <div id="p-chat-box" class="chat-box" style="background:white; border:1px solid #eee;"></div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="p-msg-input" class="form-control" style="margin:0;" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                        <button class="btn btn-primary" onclick="sendMsg('parent')">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="checkout-modal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <h2 style="color:var(--danger); margin-bottom:15px;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</h2>
            <div style="background:#f9f9f9; padding:15px; border-radius:10px; text-align:right; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between;"><span>â± Ù…Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨:</span> <span id="out-duration"></span></div>
                <div style="display:flex; justify-content:space-between;"><span>ğŸ® ØªÙƒÙ„ÙØ© Ø§Ù„Ù„Ø¹Ø¨:</span> <span id="out-play-cost"></span></div>
                <div style="display:flex; justify-content:space-between; color:var(--accent);"><span>ğŸ¿ Ø·Ù„Ø¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</span> <span id="out-orders-cost"></span></div>
                <hr style="margin:10px 0; border:0; border-top:1px dashed #ccc;">
                <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.2rem;"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span> <span id="out-total"></span></div>
            </div>
            <button class="btn btn-danger" onclick="confirmCheckout()" style="width:100%;">ØªØ£ÙƒÙŠØ¯ ÙˆØ¯ÙØ¹</button>
            <button class="btn btn-outline" onclick="closeModals()" style="width:100%; margin-top:10px;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="orders-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ›’ Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨Ø§Øª</h3>
            <h5 id="order-cname" style="color:#777; margin-bottom:15px;"></h5>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="order-item" class="form-control" placeholder="Ø§Ù„ØµÙ†Ù (Ø¹ØµÙŠØ±..)">
                <input type="number" id="order-price" class="form-control" placeholder="Ø§Ù„Ø³Ø¹Ø±" style="width:80px;">
            </div>
            <button class="btn btn-success" onclick="addOrder()" style="width:100%;">Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ§ØªÙˆØ±Ø©</button>
        </div>
    </div>

    <div id="chat-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3 id="chat-cname">Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
                <span onclick="closeModals()" style="cursor:pointer; font-size:1.5rem;">&times;</span>
            </div>
            <div id="admin-chat-box" class="chat-box"></div>
            <div class="quick-replies">
                <span class="chip" onclick="quickRep('Ø§Ù„Ø·ÙÙ„ Ø¨Ø®ÙŠØ± ÙˆÙ…Ø¨Ø³ÙˆØ· â¤ï¸')">Ø§Ù„Ø·ÙÙ„ Ø¨Ø®ÙŠØ± â¤ï¸</span>
                <span class="chip" onclick="quickRep('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù… ğŸƒâ€â™‚ï¸')">Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ğŸƒâ€â™‚ï¸</span>
                <span class="chip" onclick="quickRep('Ù…Ø­ØªØ§Ø¬ ÙŠØºÙŠØ± Ù…Ù„Ø§Ø¨Ø³ ğŸ‘•')">Ù…Ù„Ø§Ø¨Ø³ ğŸ‘•</span>
                <span class="chip" onclick="quickRep('ØªÙ… Ø·Ù„Ø¨ ÙˆØ¬Ø¨Ø© ğŸ¿')">Ø·Ù„Ø¨ ÙˆØ¬Ø¨Ø© ğŸ¿</span>
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="admin-msg-input" class="form-control" style="margin:0;" placeholder="Ø§Ù„Ø±Ø¯...">
                <button class="btn btn-primary" onclick="sendMsg('admin')">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <div id="reports-modal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <h3 style="margin-bottom:20px;">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
            <div class="stats-grid">
                <div class="stat-box"><h4>Ø§Ù„ÙŠÙˆÙ…</h4><div id="stat-day" class="stat-val">0</div></div>
                <div class="stat-box"><h4>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h4><div id="stat-week" class="stat-val">0</div></div>
                <div class="stat-box"><h4>Ø§Ù„Ø´Ù‡Ø±</h4><div id="stat-month" class="stat-val">0</div></div>
            </div>
            <canvas id="financeChart" style="width:100%; height:250px;"></canvas>
            <button class="btn btn-outline" onclick="closeModals()" style="width:100%; margin-top:20px;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <audio id="sound-notif" src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_3f32527b79.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, set, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDJ_dnEZP62J871KLAg88_quQdUt01004o",
            authDomain: "operakides.firebaseapp.com",
            projectId: "operakides",
            storageBucket: "operakides.firebasestorage.app",
            messagingSenderId: "1028823199618",
            appId: "1:1028823199618:web:16062acdd68c32002a299b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- State ---
        let allData = {};
        let currentId = null; // For modals
        let reportChart = null;

        // --- Helpers ---
        const playSound = () => document.getElementById('sound-notif').play().catch(()=>{});
        const closeModals = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        const formatTime = (ms) => {
            const s = Math.floor((ms/1000)%60).toString().padStart(2,'0');
            const m = Math.floor((ms/60000)%60).toString().padStart(2,'0');
            const h = Math.floor(ms/3600000).toString().padStart(2,'0');
            return `${h}:${m}:${s}`;
        };

        // --- Login ---
        window.checkLogin = () => {
            if(document.getElementById('login-pass').value === '0100') {
                document.getElementById('login-screen').style.display='none';
                document.getElementById('admin-view').classList.remove('hidden');
                document.getElementById('admin-controls').classList.remove('hidden');
                initAdmin();
            } else alert('Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
        };

        // --- Calculation Logic (Smart Pause) ---
        function getDetails(c) {
            let duration = 0;
            const now = Date.now();
            
            if(c.status === 'out') {
                duration = c.exitTime - c.entryTime - (c.totalPaused || 0);
            } else if (c.status === 'paused') {
                duration = c.pauseStart - c.entryTime - (c.totalPaused || 0);
            } else {
                duration = now - c.entryTime - (c.totalPaused || 0);
            }

            const hours = Math.ceil(duration / 3600000); // 1 hour min, then ceiling
            const playCost = hours * 50; 
            
            let ordersCost = 0;
            if(c.orders) Object.values(c.orders).forEach(o => ordersCost += parseFloat(o.price));

            return { duration, playCost, ordersCost, total: playCost + ordersCost, str: formatTime(duration) };
        }

        // --- Admin Functions ---
        function initAdmin() {
            onValue(ref(db, 'children'), snap => {
                allData = snap.val() || {};
                renderKids();
            });
            setInterval(() => {
                document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('ar-EG');
                renderKids(true); // Re-render for timer updates only if needed, better to optimize
            }, 1000);
        }

        window.renderKids = (timerOnly = false) => {
            if(timerOnly && !document.getElementById('search-box').value) {
                // Optimize: just update timers text
                document.querySelectorAll('.live-timer-text').forEach(el => {
                    const id = el.dataset.id;
                    if(allData[id]) el.innerText = getDetails(allData[id]).str;
                });
                return;
            }

            const q = document.getElementById('search-box').value.toLowerCase();
            const activeDiv = document.getElementById('active-list');
            const histDiv = document.getElementById('history-list');
            activeDiv.innerHTML = ''; histDiv.innerHTML = '';

            Object.keys(allData).reverse().forEach(key => {
                const c = allData[key];
                if((c.name+c.phone).toLowerCase().includes(q)) {
                    const det = getDetails(c);
                    
                    if(c.status !== 'out') {
                        const isPaused = c.status === 'paused';
                        const div = document.createElement('div');
                        div.className = `kid-card ${isPaused ? 'status-paused' : 'status-in'}`;
                        div.innerHTML = `
                            <div class="kid-header">
                                <div>
                                    <h3 style="margin:0;">${c.name}</h3>
                                    <div style="font-size:0.8rem; color:#777;">${c.phone}</div>
                                </div>
                                <div style="text-align:left;">
                                    ${isPaused ? '<span class="paused-badge">Ù…ØªÙˆÙ‚Ù</span>' : ''}
                                    <div class="kid-timer live-timer-text" data-id="${key}">${det.str}</div>
                                    <div style="font-size:0.8rem; font-weight:bold; margin-top:2px;">${det.total} Ø¬.Ù…</div>
                                </div>
                            </div>
                            <div class="controls-row">
                                <button class="btn btn-info" onclick="openOrders('${key}','${c.name}')"><i class="fas fa-cart-plus"></i></button>
                                <button class="btn btn-whatsapp" onclick="window.open('https://wa.me/${c.phone}','_blank')"><i class="fab fa-whatsapp"></i></button>
                                <button class="btn btn-primary" onclick="openChat('${key}','${c.name}')"><i class="fas fa-comments"></i></button>
                                <button class="btn btn-warning" onclick="togglePause('${key}')">${isPaused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>'}</button>
                                <button class="btn btn-danger" onclick="preCheckout('${key}')">Ø®Ø±ÙˆØ¬</button>
                            </div>
                        `;
                        activeDiv.appendChild(div);
                    } else {
                        const div = document.createElement('div');
                        div.className = 'kid-card status-out';
                        div.style.opacity = '0.7';
                        div.innerHTML = `
                            <div class="kid-header">
                                <div><h3>${c.name}</h3><small>ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬</small></div>
                                <div style="font-weight:bold; font-size:1.2rem;">${c.totalCost} Ø¬.Ù…</div>
                            </div>
                        `;
                        histDiv.appendChild(div);
                    }
                }
            });
        };

        window.checkIn = () => {
            const name = document.getElementById('child-name').value;
            const phone = document.getElementById('child-phone').value;
            if(!name) return;
            const newRef = push(ref(db, 'children'));
            const link = `${location.origin}${location.pathname}?id=${newRef.key}`;
            set(newRef, { name, phone, entryTime: Date.now(), status: 'in', totalPaused: 0 }).then(()=>{
                document.getElementById('child-name').value = '';
                document.getElementById('child-phone').value = '';
                document.getElementById('qr-area').classList.remove('hidden');
                document.getElementById('qrcode').innerHTML = '';
                new QRCode(document.getElementById('qrcode'), {text:link, width:100, height:100});
                document.getElementById('wa-share-btn').onclick = () => window.open(`https://wa.me/${phone}?text=Ø±Ø§Ø¨Ø· Ù…ØªØ§Ø¨Ø¹Ø© Ø·ÙÙ„Ùƒ: ${link}`);
                window.currentLink = link;
            });
        };

        window.copyLink = () => { navigator.clipboard.writeText(window.currentLink); alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®'); };

        // --- Logic: Pause/Resume ---
        window.togglePause = (id) => {
            const c = allData[id];
            if(c.status === 'in') {
                update(ref(db, `children/${id}`), { status: 'paused', pauseStart: Date.now() });
            } else {
                const diff = Date.now() - c.pauseStart;
                update(ref(db, `children/${id}`), { status: 'in', totalPaused: (c.totalPaused||0) + diff, pauseStart: null });
            }
        };

        // --- Logic: Orders ---
        window.openOrders = (id, name) => {
            currentId = id;
            document.getElementById('order-cname').innerText = name;
            document.getElementById('orders-modal').style.display = 'flex';
        };
        window.addOrder = () => {
            const item = document.getElementById('order-item').value;
            const price = document.getElementById('order-price').value;
            if(!item || !price) return;
            push(ref(db, `children/${currentId}/orders`), { item, price: parseFloat(price) });
            document.getElementById('order-item').value = '';
            document.getElementById('order-price').value = '';
            closeModals();
        };

        // --- Logic: Checkout ---
        window.preCheckout = (id) => {
            currentId = id;
            const det = getDetails(allData[id]);
            document.getElementById('out-duration').innerText = det.str;
            document.getElementById('out-play-cost').innerText = det.playCost;
            document.getElementById('out-orders-cost').innerText = det.ordersCost;
            document.getElementById('out-total').innerText = det.total + ' Ø¬.Ù…';
            document.getElementById('checkout-modal').style.display = 'flex';
        };
        window.confirmCheckout = () => {
            const det = getDetails(allData[currentId]);
            update(ref(db, `children/${currentId}`), { status:'out', exitTime: Date.now(), totalCost: det.total });
            closeModals();
        };

        // --- Logic: Chat ---
        window.openChat = (id, name) => {
            currentId = id;
            document.getElementById('chat-cname').innerText = name;
            document.getElementById('chat-modal').style.display = 'flex';
            onValue(ref(db, `children/${id}/messages`), snap => {
                const box = document.getElementById('admin-chat-box');
                box.innerHTML = '';
                if(snap.exists()) {
                    Object.values(snap.val()).forEach(m => {
                        box.innerHTML += `<div class="msg ${m.sender}">${m.text}</div>`;
                    });
                    box.scrollTop = box.scrollHeight;
                }
            });
        };
        window.quickRep = (txt) => document.getElementById('admin-msg-input').value = txt;
        
        window.sendMsg = (sender) => {
            const inp = document.getElementById(sender === 'admin' ? 'admin-msg-input' : 'p-msg-input');
            const txt = inp.value;
            if(!txt) return;
            // if sender is parent, get ID from URL, else use currentId
            const id = sender === 'admin' ? currentId : new URLSearchParams(location.search).get('id');
            push(ref(db, `children/${id}/messages`), { text: txt, sender, time: Date.now() });
            inp.value = '';
            playSound();
        };

        // --- Logic: Reports (Chart.js) ---
        window.openReports = () => {
            document.getElementById('reports-modal').style.display = 'flex';
            get(ref(db, 'children')).then(snap => {
                const now = Date.now();
                let day=0, week=0, month=0;
                let dayMap = { 'Ø§Ù„Ø³Ø¨Øª':0, 'Ø§Ù„Ø£Ø­Ø¯':0, 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†':0, 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡':0, 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡':0, 'Ø§Ù„Ø®Ù…ÙŠØ³':0, 'Ø§Ù„Ø¬Ù…Ø¹Ø©':0 };
                
                snap.forEach(s => {
                    const c = s.val();
                    if(c.status === 'out') {
                        const cost = parseFloat(c.totalCost || 0);
                        const diff = now - c.exitTime;
                        if(diff < 86400000) day += cost;
                        if(diff < 604800000) week += cost;
                        if(diff < 2592000000) month += cost;
                        
                        const dName = new Date(c.exitTime).toLocaleDateString('ar-EG', {weekday:'long'});
                        if(dayMap[dName] !== undefined) dayMap[dName] += cost;
                    }
                });
                
                document.getElementById('stat-day').innerText = day;
                document.getElementById('stat-week').innerText = week;
                document.getElementById('stat-month').innerText = month;
                
                // Chart
                const ctx = document.getElementById('financeChart').getContext('2d');
                if(reportChart) reportChart.destroy();
                reportChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(dayMap),
                        datasets: [{ label: 'Ø§Ù„Ø£Ø±Ø¨Ø§Ø­', data: Object.values(dayMap), backgroundColor: '#ff4757', borderRadius: 5 }]
                    },
                    options: { responsive: true, plugins: { legend: {display: false} } }
                });
            });
        };

        // --- Parent View Logic ---
        const urlId = new URLSearchParams(location.search).get('id');
        if(urlId) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('parent-view').classList.remove('hidden');
            onValue(ref(db, `children/${urlId}`), snap => {
                const c = snap.val();
                if(!c) return;
                document.getElementById('p-child-name').innerText = c.name;
                
                if(c.status === 'out') {
                    document.getElementById('p-status-badge').innerText = 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©';
                    document.getElementById('p-status-badge').style.background = '#ccc';
                    document.getElementById('p-cost').innerText = c.totalCost;
                    return;
                }

                // Update UI based on status
                if(c.status === 'paused') {
                    document.getElementById('p-status-badge').innerText = 'Ù…ØªÙˆÙ‚Ù Ù…Ø¤Ù‚ØªØ§Ù‹';
                    document.getElementById('p-status-badge').style.background = 'orange';
                } else {
                    document.getElementById('p-status-badge').innerText = 'ÙŠÙ„Ø¹Ø¨ Ø§Ù„Ø¢Ù†';
                    document.getElementById('p-status-badge').style.background = 'var(--success)';
                }

                // Live Update
                const updateParent = () => {
                    const det = getDetails(c);
                    document.getElementById('p-cost').innerText = det.total;
                    document.getElementById('p-timer').innerText = det.str;
                };
                updateParent();
                if(!window.pInterval) window.pInterval = setInterval(updateParent, 1000);

                // Orders List
                const oList = document.getElementById('p-orders-list');
                oList.innerHTML = '';
                if(c.orders) Object.values(c.orders).forEach(o => oList.innerHTML += `<div>${o.item} - ${o.price} Ø¬.Ù…</div>`);

                // Chat
                const chatBox = document.getElementById('p-chat-box');
                chatBox.innerHTML = '';
                if(c.messages) {
                    Object.values(c.messages).forEach(m => chatBox.innerHTML += `<div class="msg ${m.sender}">${m.text}</div>`);
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            });
        }
    </script>
</body>
</html>
